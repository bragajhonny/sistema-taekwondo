<!DOCTYPE HTML>
<html>
	<head>
		<title>Hist√≥rico de presen√ßa - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
			.modal {
				display: none;
				position: fixed;
				z-index: 999;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.6);
			}
			
			.modal-content {
				background: #fff;
				margin: 5% auto;
				padding: 20px;
				width: 95%;
				max-width: 600px;
				border-radius: 8px;
				max-height: 85vh;
				overflow-y: auto;
			}
			
			.fechar {
				float: right;
				font-size: 22px;
				cursor: pointer;
			}
			
			.pergunta {
				margin-bottom: 15px;
			}
			
			.escala label {
				margin-right: 10px;
			}
		</style>
	</head>

	<body>
		<div id="wrapper">
			<header id="header">
				<div class="inner">
					<a href="index.html" class="logo">
						<span class="symbol"><img src="images/logo.svg" alt="" /></span>
						<span class="title">CT Gerivaldo Silva</span>
					</a>
				</div>
	
				<nav>
					<ul>
						<li><a href="#menu">Menu</a></li>
					</ul>
				</nav>
			</header>
	
			<!-- MENU -->
			<nav>
				<h2>Menu</h2>
				<ul id="menuLinks"></ul>
				<input type="button" value="Sair" class="primary" onclick="logout()" />
			</nav>
	
			<!-- Main -->
			<div id="main">
				<div class="inner">
					<section>
						<h1>Minhas presen√ßas</h1>
						<table>
							<thead>
								<tr>
									<th>Data</th>
									<th>Tipo de Treino</th>
									<th>Avalia√ß√£o</th>
								</tr>
							</thead>
							<tbody id="listaPresencas"></tbody>
						</table>
					</section>
				</div>
			</div>
	
			<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			
			<script>
				const API_URL = 'https://script.google.com/macros/s/AKfycbxAAPLWqmKrbuyOT4KgaFlM0IFEPPNVkVlEFq8UZEXSZDw2gunsXSFqevwjt-oWIK2F-w/exec';
				const usuario = JSON.parse(localStorage.getItem('usuario'));
			
				let dataSelecionada = '';
				let tipoTreinoSelecionado = '';

				/* =========================
				   MENU DIN√ÇMICO
				========================= */
				function configurarMenu() {
					const menu = document.getElementById('menuLinks');
					menu.innerHTML = '';
					menu.innerHTML += `<li><a href="perfil.html">Meu perfil</a></li>`;
					menu.innerHTML += `<li><a href="editar-dados.html">Editar dados</a></li>`;
					menu.innerHTML += `<li><a href="historico-aluno.html">Hist√≥rico de presen√ßa</a></li>`;
					
					if (usuario.tipo === 'professor') {
						menu.innerHTML += `<li><a href="presenca.html">Presen√ßa</a></li>
						<li><a href="professor.html">Painel do professor</a></li>
					`;
					}
				}

				/* =========================
				   GERAR ESCALA DE 1 A 5
				========================= */
				document.addEventListener('DOMContentLoaded', () => {
					if (!usuario) { //verifica se o usu√°rio est√° logado
						window.location.href = 'index.html';
						return;
					}

					configurarMenu();
					listarPresencas();
					
					// Gerar escalas automaticamente
					document.querySelectorAll(".escala").forEach(div => {
						const nome = div.getAttribute("data-name");
						for (let i = 1; i <= 5; i++) {
							div.innerHTML += `
							<label>
							<input type="radio" name="${nome}" value="${i}" required> ${i}
							</label>
							`;
						}
					});
					document.getElementById('formQuestionario').addEventListener('submit', salvarFormulario);
				});
			
				function listarPresencas() {
					fetch(API_URL, {
						method: 'POST',
						body: new URLSearchParams({
							acao: 'listarMinhasPresencas',
							idUsuario: usuario.idUsuario
						})
					})
					.then(r => r.json())
					.then(res => {
					
						const tbody = document.getElementById('listaPresencas');
						tbody.innerHTML = '';
						
						if (!res.dados || res.dados.length === 0) {
							tbody.innerHTML = '<tr><td colspan="3">Nenhuma presen√ßa encontrada</td></tr>';
							return;
						}
						res.dados.forEach(item => {
							tbody.innerHTML += `
							<tr>
								<td>${formatarData(item.data)}</td>
								<td>${item.tipoTreino || '-'}</td>
								<td>
								${item.respondido
								? '‚úÖ Respondido'
								: `<button onclick="abrirModal('${item.data}', '${item.tipoTreino || ''}')">Responder</button>`
								}
								</td>
							</tr>
							`;
						});
					});
				}
			
				function abrirModal(data, tipoTreino) {
					dataSelecionada = data;
					tipoTreinoSelecionado = (tipoTreino || '').toLowerCase();
					document.getElementById("modalQuestionario").style.display = "block";
					document.getElementById("blocoPoomsae").style.display =
					tipoTreinoSelecionado.includes("poomsae") ? "block" : "none";
					document.getElementById("blocoKyorugui").style.display =
					tipoTreinoSelecionado.includes("kyorugui") ? "block" : "none";
				}
			
				function fecharModal() {
					document.getElementById("modalQuestionario").style.display = "none";
				}
				
				function salvarFormulario(e) {
					e.preventDefault();
					const formData = new FormData(e.target);
					const respostas = {};
					for (let [key, value] of formData.entries()) {
						respostas[key] = value;
					}
					
					fetch(API_URL, {
						method: 'POST',
						body: new URLSearchParams({
							acao: 'salvarAvaliacao',
							idUsuario: usuario.idUsuario,
							data: dataSelecionada,
							tipoTreino: tipoTreinoSelecionado,
							respostas: JSON.stringify(respostas)
						})
					})
					.then(r => r.json())
					.then(res => {
						if (res.status === 'sucesso') {
							alert("Avalia√ß√£o salva com sucesso!");
							fecharModal();
							listarPresencas();
						} else {
							alert("Erro ao salvar avalia√ß√£o.");
						}
					});
				}
				
				function formatarData(dataISO) {
					const data = new Date(dataISO);
					return data.toLocaleDateString('pt-BR');
				}
				
				/* =========================
				LOGOUT
				========================= */
				function logout() {
					localStorage.removeItem('usuario');
					window.location.href = 'index.html';
				}
			</script>
	
			<!-- =================
			MODAL
			================= -->
	
			<div id="modalQuestionario" class="modal">
				<div class="modal-content">
					<span class="fechar" onclick="fecharModal()">&times;</span>
	
					<h2>Autoavalia√ß√£o do Treino</h2>
					<p>Escala: 1 (Muito fraco) at√© 5 (Excelente)</p>
	
					<form id="formQuestionario">
						<h3>ü¶µ Chutes</h3>
							<div class="pergunta"><label>Executei os chutes com boa t√©cnica.</label><div class="escala" data-name="ch1"></div></div>
							<div class="pergunta"><label>Mantive equil√≠brio ap√≥s os chutes.</label><div class="escala" data-name="ch2"></div></div>
							<div class="pergunta"><label>Usei corretamente a perna de base.</label><div class="escala" data-name="ch3"></div></div>
							<div class="pergunta"><label>Mantive altura e dire√ß√£o adequadas.</label><div class="escala" data-name="ch4"></div></div>
							<div class="pergunta"><label>Demonstrei evolu√ß√£o nos chutes hoje.</label><div class="escala" data-name="ch5"></div></div>
	
						<h3>üßç Base e Postura</h3>
							<div class="pergunta"><label>Mantive bases firmes.</label><div class="escala" data-name="b1"></div></div>
							<div class="pergunta"><label>Ajustei corretamente os p√©s.</label><div class="escala" data-name="b2"></div></div>
							<div class="pergunta"><label>Mantive postura adequada.</label><div class="escala" data-name="b3"></div></div>
							<div class="pergunta"><label>Fiz boas transi√ß√µes de base.</label><div class="escala" data-name="b4"></div></div>
							<div class="pergunta"><label>Demonstrei seguran√ßa nas bases.</label><div class="escala" data-name="b5"></div></div>

						<div id="blocoPoomsae" style="display:none;">
							<h3>ü•ã Poomsae</h3>
								<div class="pergunta"><label>Executei com precis√£o.</label><div class="escala" data-name="p1"></div></div>
								<div class="pergunta"><label>Mantive ritmo adequado.</label><div class="escala" data-name="p2"></div></div>
								<div class="pergunta"><label>Boa coordena√ß√£o.</label><div class="escala" data-name="p3"></div></div>
								<div class="pergunta"><label>Mantive foco na sequ√™ncia.</label><div class="escala" data-name="p4"></div></div>
								<div class="pergunta"><label>Demonstrei evolu√ß√£o no poomsae.</label><div class="escala" data-name="p5"></div></div>
						</div>
	
						<div id="blocoKyorugui" style="display:none;">
							<h3>ü•ä Kyorugui</h3>
								<div class="pergunta"><label>Mantive guarda adequada.</label><div class="escala" data-name="k1"></div></div>
								<div class="pergunta"><label>Usei chutes com estrat√©gia.</label><div class="escala" data-name="k2"></div></div>
								<div class="pergunta"><label>Mantive controle emocional.</label><div class="escala" data-name="k3"></div></div>
								<div class="pergunta"><label>Apliquei t√©cnicas treinadas.</label><div class="escala" data-name="k4"></div></div>
								<div class="pergunta"><label>Demonstrei evolu√ß√£o na luta.</label><div class="escala" data-name="k5"></div></div>
						</div>
	
						<h3>üß† Disciplina</h3>
							<div class="pergunta"><label>Mantive disciplina.</label><div class="escala" data-name="d1"></div></div>
							<div class="pergunta"><label>Segui orienta√ß√µes.</label><div class="escala" data-name="d2"></div></div>
							<div class="pergunta"><label>Demonstrei dedica√ß√£o.</label><div class="escala" data-name="d3"></div></div>
							<div class="pergunta"><label>Mantive concentra√ß√£o.</label><div class="escala" data-name="d4"></div></div>
							<div class="pergunta"><label>Dei meu melhor.</label><div class="escala" data-name="d5"></div></div>

						<br>
						<button type="submit">Salvar Avalia√ß√£o</button>
	
					</form>
				</div>
			</div>
	</body>
</html>
