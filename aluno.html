<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Painel do Aluno</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin-bottom: 10px; }
    button { margin-top: 10px; padding: 6px 12px; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 5px; }
  </style>
</head>
<body>

<h2>Painel do Aluno</h2>
<button onclick="logout()">Sair</button>

<h3>Meus Documentos</h3>

<label>RG:</label>
<input type="file" id="docRG"><br>
<label>Foto:</label>
<input type="file" id="docFoto"><br>
<label>Atestado:</label>
<input type="file" id="docAtestado"><br>

<button onclick="enviarTodosDocumentos()">Enviar Todos os Documentos</button>

<h4>Documentos enviados:</h4>
<ul id="listaDocumentos"></ul>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDTcmFtCpgb-krAJ6OniJSXIXnkoxGzWF4",
    authDomain: "sistema-taekwondo-1.firebaseapp.com",
    projectId: "sistema-taekwondo-1",
    storageBucket: "sistema-taekwondo-1.firebasestorage.app",
    messagingSenderId: "635745416768",
    appId: "1:635745416768:web:58d23eca722878f047d1a5"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  let alunoUID = null;

  // Verifica login
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    alunoUID = user.uid;
    listarDocumentos();
  });

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "index.html";
    });
  }

  // Função para enviar todos os documentos
  function enviarTodosDocumentos() {
    const arquivos = {
      rg: document.getElementById("docRG").files[0],
      foto: document.getElementById("docFoto").files[0],
      atestado: document.getElementById("docAtestado").files[0]
    };

    const promessas = [];

    for (const [tipo, file] of Object.entries(arquivos)) {
      if (!file) continue; // ignora arquivos não selecionados

      const path = `alunos/${alunoUID}/${tipo}_${file.name}`;
      const storageRef = storage.ref(path);

      const p = storageRef.put(file)
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          return db.collection("alunos").doc(alunoUID).update({
            [`documentos.${tipo}`]: url
          });
        });

      promessas.push(p);
    }

    if (promessas.length === 0) {
      alert("Nenhum arquivo selecionado!");
      return;
    }

    Promise.all(promessas)
      .then(() => {
        alert("Todos os documentos enviados com sucesso!");
        document.getElementById("docRG").value = "";
        document.getElementById("docFoto").value = "";
        document.getElementById("docAtestado").value = "";
        listarDocumentos();
      })
      .catch(err => {
        console.error(err);
        alert("Erro ao enviar os documentos");
      });
  }

  // Lista documentos enviados
  function listarDocumentos() {
    db.collection("alunos").doc(alunoUID).get()
      .then(doc => {
        const docs = doc.data().documentos || {};
        const lista = document.getElementById("listaDocumentos");
        lista.innerHTML = "";

        for (const [tipo, url] of Object.entries(docs)) {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${url}" target="_blank">${tipo.toUpperCase()}</a>`;
          lista.appendChild(li);
        }
      })
      .catch(err => console.error(err));
  }
</script>

</body>
</html>
