<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Painel do Aluno</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin-bottom: 10px; }
    button { margin-left: 10px; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 5px; }
  </style>
</head>
<body>

<h2>Painel do Aluno</h2>
<button onclick="logout()">Sair</button>

<h3>Meus Documentos</h3>

<label>RG:</label>
<input type="file" id="docRG"><button onclick="uploadDocumento('rg')">Enviar</button><br>

<label>Foto:</label>
<input type="file" id="docFoto"><button onclick="uploadDocumento('foto')">Enviar</button><br>

<label>Atestado:</label>
<input type="file" id="docAtestado"><button onclick="uploadDocumento('atestado')">Enviar</button><br>

<h4>Documentos enviados:</h4>
<ul id="listaDocumentos"></ul>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDTcmFtCpgb-krAJ6OniJSXIXnkoxGzWF4",
    authDomain: "sistema-taekwondo-1.firebaseapp.com",
    projectId: "sistema-taekwondo-1",
    storageBucket: "sistema-taekwondo-1.firebasestorage.app",
    messagingSenderId: "635745416768",
    appId: "1:635745416768:web:58d23eca722878f047d1a5"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  let alunoUID = null;

  // Verifica login
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    alunoUID = user.uid;
    listarDocumentos();
  });

  // Logout
  function logout() {
    auth.signOut().then(() => {
      window.location.href = "index.html";
    });
  }

  // Função de upload
  function uploadDocumento(tipo) {
    const input = document.getElementById(`doc${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    const file = input.files[0];

    if (!file) {
      alert("Selecione um arquivo!");
      return;
    }

    const path = `alunos/${alunoUID}/${tipo}_${file.name}`;
    const storageRef = storage.ref(path);

    storageRef.put(file)
      .then(snapshot => snapshot.ref.getDownloadURL())
      .then(url => {
        // Salva a URL no Firestore
        return db.collection("alunos").doc(alunoUID).update({
          [`documentos.${tipo}`]: url
        });
      })
      .then(() => {
        alert(`${tipo.toUpperCase()} enviado com sucesso!`);
        input.value = ""; // limpa o input
        listarDocumentos();
      })
      .catch(err => {
        console.error(err);
        alert("Erro ao enviar documento");
      });
  }

  // Lista documentos enviados
  function listarDocumentos() {
    db.collection("alunos").doc(alunoUID).get()
      .then(doc => {
        const docs = doc.data().documentos || {};
        const lista = document.getElementById("listaDocumentos");
        lista.innerHTML = "";

        for (const [tipo, url] of Object.entries(docs)) {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${url}" target="_blank">${tipo.toUpperCase()}</a>`;
          lista.appendChild(li);
        }
      })
      .catch(err => console.error(err));
  }
</script>

</body>
</html>
