<!DOCTYPE HTML>
<html>
	<head>
		<title>Histórico de Presença - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>

	<body class="is-preload">
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Header -->
			<header id="header">
				<div class="inner">
					<!-- Logo -->
					<a href="index.html" class="logo">
						<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>
				</div>
			</header>

			<!-- MENU -->
			  <nav id="menu">
				<h2>Menu</h2>
				 <ul id="menuLinks"></ul>
				<input type="button" value="Sair" class="primary" onclick="logout()" />
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">
					<h1>Histórico de presença</h1>
					<select id="dataPresenca" onchange="carregarPresenca()"></select>
					<br />

					<h3>Alunos Presentes</h3>

            				<ul id="listaAlunos">
                				<li>Selecione uma data</li>
            				</ul>

            				<ul class="actions">
               					<li><input type="button" value="Voltar" class="primary" onclick="history.back()"/></li>
            				</ul>
				</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>


		<script>
			const API_URL = 'https://script.google.com/macros/s/AKfycbyHeniztA9TghTkzgJDXgwAcYiAFyFyx8Abewk8k8ORhYOhm9rQqeHjZGBjyln_U5UQGA/exec';
			const usuario = JSON.parse(localStorage.getItem('usuario'));

			/* =========================
			   INIT
			========================= */
			document.addEventListener('DOMContentLoaded', init);
			
			function init(){ 
			  carregarDados();
			configurarMenu();
			  configurarEventos();
			}
			
			/* =========================
			   PROTEÇÃO DE ACESSO
			
			if (!usuario || usuario.tipo !== 'professor') {
			  window.location.href = 'index.html';
			}
			========================= */
			
			/* =========================
			   ELEMENTOS
			========================= */
			const select = document.getElementById('dataPresenca');
			const lista = document.getElementById('listaAlunos');
			
			/* =========================
			   CARREGAR DATAS
			========================= */
			function carregarDatas() {
			
			  select.innerHTML = '<option value="">Carregando datas...</option>';
			
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'listarDatasPresenca'
			    })
			  })
			  .then(r => r.json())
			  .then(res => {
			
			    console.log('listarDatasPresenca:', res);
			
			    select.innerHTML = '<option value="">Selecione a data</option>';
			
			    if (!res || res.status !== 'sucesso' || !Array.isArray(res.dados)) {
			      select.innerHTML = '<option value="">Erro ao carregar datas</option>';
			      return;
			    }
			
			    if (res.dados.length === 0) {
			      select.innerHTML += '<option value="">Nenhuma data encontrada</option>';
			      return;
			    }
			
			    /* Remove duplicadas */
			    const datasUnicas = new Set();
			
			    res.dados.forEach(data => {
			      const dataLimpa = String(data).substring(0, 10);
			      datasUnicas.add(dataLimpa);
			    });
			
			    /* Ordena da mais recente para mais antiga */
			    const datasOrdenadas = Array.from(datasUnicas).sort((a, b) => {
			      return new Date(b) - new Date(a);
			    });
			
			    /* Monta o select */
			    datasOrdenadas.forEach(data => {
			      const [ano, mes, dia] = data.split('-');
			      const dataFormatada = `${dia}/${mes}/${ano}`;
			
			      const option = document.createElement('option');
			      option.value = data;
			      option.textContent = dataFormatada;
			      select.appendChild(option);
			    });
			
			  })
			  .catch(() => {
			    select.innerHTML = '<option value="">Erro ao carregar datas</option>';
			  });
			}
			
			/* =========================
			   CARREGAR PRESENÇA POR DATA
			========================= */
			function carregarPresenca() {
			
			  const dataSelecionada = select.value;
			  lista.innerHTML = '';
			
			  if (!dataSelecionada) {
			    lista.innerHTML = '<li>Selecione uma data</li>';
			    return;
			  }
			
			  lista.innerHTML = '<li>Carregando...</li>';
			
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'listarPresencaPorData',
			      data: dataSelecionada
			    })
			  })
			  .then(r => r.json())
			  .then(res => {
			
			    console.log('listarPresencaPorData:', res);
			
			    lista.innerHTML = '';
			
			    if (!res || res.status !== 'sucesso' || !Array.isArray(res.dados)) {
			      lista.innerHTML = '<li>Erro ao carregar presença</li>';
			      return;
			    }
			
			    if (res.dados.length === 0) {
			      lista.innerHTML = '<li>Nenhum aluno presente</li>';
			      return;
			    }
			
			    res.dados.forEach(nome => {
			      const li = document.createElement('li');
			      li.textContent = nome;
			      lista.appendChild(li);
			    });
			
			  })
			  .catch(() => {
			    lista.innerHTML = '<li>Erro ao carregar presença</li>';
			  });
			}

			function configurarMenu() {
				  const menu = document.getElementById('menuLinks');
				  menu.innerHTML = '';
				
				  menu.innerHTML += `<li><a href="perfil.html">Meu perfil</a></li>`;
				  menu.innerHTML += `<li><a href="editar-dados.html">Editar dados</a></li>`;
					menu.innerHTML += `<li><a href="historico-aluno.html">Histórico de presença</a></li>`;
				
				  if (usuario.tipo === 'professor') {
				    menu.innerHTML += `<li><a href="presenca.html">Presença</a></li>
				    <li><a href="professor.html">Painel do professor</a></li>
				    `;
				  }
				}
			
			/* =========================
			   LOGOUT
			========================= */
			function logout() {
			  localStorage.removeItem('usuario');
			  window.location.href = 'index.html';
			}
			
			/* =========================
			   INICIALIZAÇÃO
			========================= */
			document.addEventListener('DOMContentLoaded', carregarDatas);
			</script>


	</body>
</html>
