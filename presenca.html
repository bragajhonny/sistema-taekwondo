<!DOCTYPE HTML>
<html>
	<head>
		<title>Controle de presença - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>

	<body class="is-preload">
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Header -->
			<header id="header">
				<div class="inner">
					<!-- Logo -->
					<a href="index.html" class="logo">
						<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>
				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					<li><a href="professor.html">Painel do professor</a></li>
					<li><a href="presenca.html">Presença</a></li>
					<li><a href="historico-aluno.html">Histórico de presença</a></li>
					<input type="button" value="Sair" class="primary" onclick="logout()" />
				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">
					<h1>Presença</h1>
					<ul>
						<input type="date" id="dataAula">
					</ul>
					
					<table>
        					<thead>
          						<tr>
								<th>Nome</th>
								<th>Presença</th>
							</tr>
						</thead>
						<tbody id="listaAlunos"></tbody>
					</table>
					<ul class="actions">
						<li><input type="submit" value="Marcar presença" class="primary" onclick="salvarPresenca()" /></li>
						<li><input type="button" value="Voltar" class="primary" onclick="history.back()"/></li>
					</ul>
				</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
<script>
const usuario = JSON.parse(localStorage.getItem('usuario'));

if (!usuario || usuario.tipo !== 'professor') {
  window.location.href = 'index.html';
}

const API_URL = 'https://script.google.com/macros/s/AKfycbw3iRxCxjsjc78Lnnu-bT43lVO2ZP6L2jd01LJ1_R8R4Vox4LO-HQ1z9P1-YSs4gjHrpw/exec';

/* DATA LOCAL (SEM UTC) */
const hoje = new Date();
hoje.setMinutes(hoje.getMinutes() - hoje.getTimezoneOffset());
document.getElementById('dataAula').value =
  hoje.toISOString().split('T')[0];

/* LISTAR ALUNOS + PROFESSORES */
fetch(API_URL, {
  method: 'POST',
  body: new URLSearchParams({
    acao: 'listarAlunosPresenca'
  })
})
.then(r => r.json())
.then(res => {
  const tbody = document.getElementById('listaAlunos');
  tbody.innerHTML = '';

  if (!res.dados || !res.dados.length) {
    tbody.innerHTML = '<tr><td colspan="2">Nenhum registro encontrado</td></tr>';
    return;
  }

  res.dados.forEach(pessoa => {
    const tr = document.createElement('tr');
    const checkboxId = `presenca-${pessoa.id}`;

    tr.innerHTML = `
      <td>
        ${pessoa.nome}
        <small style="opacity:0.6">(${pessoa.tipo})</small>
      </td>
      <td style="text-align:left">
        <input
          type="checkbox"
          id="${checkboxId}"
          data-id="${pessoa.id}"
          data-nome="${pessoa.nome}"
          data-tipo="${pessoa.tipo}"
        >
        <label for="${checkboxId}"></label>
      </td>
    `;

    tbody.appendChild(tr);
  });
})
.catch(() => {
  document.getElementById('listaAlunos').innerHTML =
    '<tr><td colspan="2">Erro ao carregar lista</td></tr>';
});

/* SALVAR PRESENÇA */
function salvarPresenca() {
  const data = document.getElementById('dataAula').value;
  if (!data) {
    alert('Selecione a data');
    return;
  }

  const registros = {};

  document.querySelectorAll('#listaAlunos input[type="checkbox"]')
    .forEach(cb => {
      registros[cb.dataset.id] = {
        nome: cb.dataset.nome,
        tipo: cb.dataset.tipo,
        presente: cb.checked
      };
    });

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'salvarPresenca',
      data: data,
      registros: JSON.stringify(registros)
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'sucesso') {
      alert('Presença salva com sucesso');
    } else {
      alert(res.msg || 'Erro ao salvar presença');
    }
  })
  .catch(() => alert('Erro ao salvar presença'));
}

/* LOGOUT */
function logout() {
  localStorage.removeItem('usuario');
  window.location.href = 'index.html';
}
</script>

			
	</body>
</html>
