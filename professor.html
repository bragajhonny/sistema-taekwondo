<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel do Professor</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

  <!-- HEADER -->
<div class="header">
  <h1>Professor</h1>
  <div>
    <button class="btn btn-secondary" onclick="window.location.href='presenca.html'">
      Presen√ßa
    </button>
    <button class="btn btn-secondary" onclick="window.location.href='historico-aula.html'">
      Hist√≥rico de Aulas
    </button>
    <button class="btn btn-danger" onclick="logout()">Sair</button>
  </div>
</div>


  <!-- CONTE√öDO -->
  <div class="card">
    <h3>Alunos cadastrados</h3>

    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Faixa</th>
            <th>Data</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaAlunos"></tbody>
      </table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDTcmFtCpgb-krAJ6OniJSXIXnkoxGzWF4",
      authDomain: "sistema-taekwondo-1.firebaseapp.com",
      projectId: "sistema-taekwondo-1",
      messagingSenderId: "635745416768",
      appId: "1:635745416768:web:58d23eca722878f047d1a5"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    // üîê Prote√ß√£o de acesso
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      db.collection("alunos").doc(user.uid).get()
        .then(doc => {
          if (!doc.exists || doc.data().perfil !== "professor") {
            alert("Acesso negado");
            window.location.href = "index.html";
            return;
          }
          carregarAlunos();
        });
    });

    // üìã Carregar alunos
    async function carregarAlunos() {
      const snapshot = await db.collection("alunos")
        .where("perfil", "==", "aluno")
        .orderBy("nome")
        .get();

      const tbody = document.getElementById("listaAlunos");
      tbody.innerHTML = "";

      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='6'>Nenhum aluno cadastrado</td></tr>";
        return;
      }

      snapshot.forEach(async doc => {
        const a = doc.data();

        // Carregar datas de presen√ßa existentes
        const presencasSnap = await db.collection("presencas")
          .orderBy("data", "desc")
          .get();

        let options = '<option value="">Selecionar</option>';
        presencasSnap.forEach(pDoc => {
          options += `<option value="${pDoc.id}">${pDoc.id}</option>`;
        });

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.nome}</td>
          <td>${a.email}</td>
          <td>${a.telefone || ""}</td>
          <td>
            <select id="faixa-${doc.id}">
              <option value="">-- Faixa --</option>
              <option${a.faixa==="branca"?" selected":""}>branca</option>
              <option${a.faixa==="branca/amarela"?" selected":""}>branca/amarela</option>
              <option${a.faixa==="amarela"?" selected":""}>amarela</option>
              <option${a.faixa==="amarela/verde"?" selected":""}>amarela/verde</option>
              <option${a.faixa==="verde"?" selected":""}>verde</option>
              <option${a.faixa==="verde/azul"?" selected":""}>verde/azul</option>
              <option${a.faixa==="azul"?" selected":""}>azul</option>
              <option${a.faixa==="azul/vermelha"?" selected":""}>azul/vermelha</option>
              <option${a.faixa==="vermelha"?" selected":""}>vermelha</option>
              <option${a.faixa==="vermelha/preta"?" selected":""}>vermelha/preta</option>
              <option${a.faixa==="preta"?" selected":""}>preta</option>
            </select>
          </td>
          <td>
            <select id="data-${doc.id}">
              ${options}
            </select>
          </td>
          <td>
            <button class="btn btn-success mb-10" onclick="salvarFaixa('${doc.id}')">
              Salvar
            </button>
            <button class="btn btn-secondary mb-10" onclick="verFicha('${doc.id}')">
              Ficha
            </button>
            <button class="btn btn-primary mb-10" onclick="verHistorico('${doc.id}')">
              Hist√≥rico
            </button>
            <button class="btn btn-danger" onclick="removerAluno('${doc.id}', '${a.nome}')">
              Remover
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // üéØ Salvar faixa
    function salvarFaixa(alunoId) {
      const faixa = document.getElementById(`faixa-${alunoId}`).value;
      if (!faixa) {
        alert("Informe a faixa");
        return;
      }
      if (!confirm("Deseja salvar a nova faixa?")) return;

      db.collection("alunos").doc(alunoId).update({ faixa })
        .then(() => alert("Faixa atualizada com sucesso"))
        .catch(err => alert("Erro ao atualizar faixa"));
    }

    // üìÑ Ver ficha
    function verFicha(alunoId) {
      window.location.href = `ficha-aluno.html?id=${alunoId}`;
    }

    // üìä Ver hist√≥rico
    function verHistorico(alunoId) {
      const selectData = document.getElementById(`data-${alunoId}`);
      const dataSelecionada = selectData.value;

      if (!dataSelecionada) {
        alert("Selecione uma data para ver o hist√≥rico");
        return;
      }

      window.location.href = `historico-aluno.html?uid=${alunoId}&data=${dataSelecionada}`;
    }

    // üóëÔ∏è Remover aluno
    function removerAluno(id, nome) {
      if (!confirm(`Deseja remover o aluno ${nome}?`)) return;

      db.collection("alunos").doc(id).delete()
        .then(() => {
          alert("Aluno removido");
          carregarAlunos();
        })
        .catch(() => alert("Erro ao remover aluno"));
    }

    // üö™ Logout
    function logout() {
      auth.signOut().then(() => window.location.href = "index.html");
    }
  </script>

</body>
</html>
