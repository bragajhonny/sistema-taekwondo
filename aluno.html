<!DOCTYPE HTML>
<html>
	<head>
		<title>Painel do Aluno - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

		<script>
			const usuario = JSON.parse(localStorage.getItem('usuario'));

			if (!usuario || usuario.tipo !== 'aluno') {
  				window.location.href = 'index.html';
			}
		</script>

	</head>

	<body class="is-preload">
	<!-- Wrapper -->
	<div id="wrapper">
		<!-- Header -->
		<header id="header">
			<div class="inner">
				<!-- Logo -->
				<a href="index.html" class="logo">
					<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
				</a>
			</div>

			<!-- Nav -->
			<nav>
				<ul>
					<li><a href="#menu">Menu</a></li>
				</ul>
			</nav>
		</header>

		<!-- Menu -->
		<nav id="menu">
			<h2>Menu</h2>
			<ul>
				<li><a href="historico-aluno.html">HistÃ³rico de presenÃ§a</a></li>
				<li><a href="#" onclick="abrirModalTrocarSenha()">Trocar senha</a></li>
				<input type="button" value="Sair" class="primary" onclick="logout()" />
			</ul>
		</nav>

		<!-- Main -->
		<div id="main">
			<div class="inner">
				<h1>Painel do Aluno</h1>
						
				<table>
					<tbody>
						<tr>
							<td>Nome</td>
							<td><input type="text" id="nome" placeholder="Nome"></td>
						</tr>
						<tr>
							<td>Data de nascimento</td>
							<td><input type="text" id="dataNascimento"></td>
						</tr>
						<tr>
							<td>Sexo</td>
							<td><input type="text" id="sexo"></td>
						</tr>
						<tr>
							<td>Telefone</td>
							<td><input type="text" id="telefone"></td>
						</tr>
						<tr>
							<td>EndereÃ§o</td>
							<td><input type="text" id="endereco" placeholder="EndereÃ§o"></td>
						</tr>
						<tr>
							<td>Tipo Sanguineo</td>
							<td><input type="text" id="tipoSanguineo"></td>
						</tr>
						<tr>
							<td>RG</td>
							<td><input type="text" id="rg" placeholder="RG" ></td>
						</tr>
						<tr>
							<td>CPF</td>
							<td><input type="text" id="cpf" placeholder="CPF" ></td>
						</tr>
						<tr>
							<td>E-mail</td>
							<td><input type="text" id="email" disabled></td>
						</tr>
						<tr>
							<td>Faixa</td>
							<td><input type="text" id="faixa" disabled></td>
						</tr>
					</tbody>
				</table>
				<ul class="actions">
					<li><input type="button" value="Salvar alteraÃ§Ãµes" class="primary" onclick="salvarDados()" /></li>
					<li><input type="button" value="Minha pasta" onclick="window.open(window.pastaDriveAluno, '_blank')" /></li>
					<li><input type="button" value="Documentos" onclick="abrirModalArquivosAluno()" /> </li>
					<li><input type="file" id="foto" accept="image/*"></li>
					<li><img id="preview" style="max-width:120px;border-radius:50%;"></li>
				</ul>
			</div>
		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzDViYiAonVM4EgCcg2CJWfqqYcVGCdE0EQik6PiP0-e_yU-dlkUc59QypLyY3V6nqe1w/exec';

fetch(API_URL, {
  method: 'POST',
  body: new URLSearchParams({
    acao: 'buscarAluno',
    email: usuario.email
  })
})
.then(r => r.json())
.then(res => {
  if (res.status !== 'sucesso') {
    alert(res.msg);
    return;
  }

  const a = res.dados;

  document.getElementById('nome').value = a.nome;
  document.getElementById('dataNascimento').value = a.dataNascimento;
  document.getElementById('sexo').value = a.sexo;
  document.getElementById('telefone').value = a.telefone;
  document.getElementById('endereco').value = a.endereco;
  document.getElementById('tipoSanguineo').value = a.tipoSanguineo;
  document.getElementById('rg').value = a.rg;
  document.getElementById('cpf').value = a.cpf;
  document.getElementById('email').value = a.email;
  document.getElementById('faixa').value = a.faixa || 'NÃ£o definida';

  // guarda link da pasta para uso futuro
  window.pastaDriveAluno = a.pastaDrive;
})
.catch(() => {
  alert('Erro ao carregar dados do aluno');
});

// LOGOUT
function logout() {
  localStorage.removeItem('usuario');
  window.location.href = 'index.html';
}

// SALVAR ALTERAÃ‡Ã•ES (vamos implementar jÃ¡ jÃ¡)
function salvarDados() {
  const dados = {
    acao: 'atualizarAluno',
    email: usuario.email,
    nome: document.getElementById('nome').value,
    dataNascimento: document.getElementById('dataNascimento').value,
    sexo: document.getElementById('sexo').value,
    telefone: document.getElementById('telefone').value,
    endereco: document.getElementById('endereco').value,
    tipoSanguineo: document.getElementById('tipoSanguineo').value,
    rg: document.getElementById('rg').value,
    cpf: document.getElementById('cpf').value
  };

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams(dados)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'sucesso') {
      alert('Dados salvos com sucesso');
    } else {
      alert(res.msg);
    }
  })
  .catch(() => {
    alert('Erro ao salvar dados');
  });
}

	function logout() {
  localStorage.removeItem('usuario');
  window.location.href = 'index.html';
}

	function enviarArquivo() {
  const input = document.getElementById('arquivoAluno');
  const file = input.files[0];

  if (!file) {
    alert('Selecione um arquivo');
    return;
  }

  const reader = new FileReader();

  reader.onload = function () {
    const base64 = reader.result.split(',')[1];

    fetch(API_URL, {
      method: 'POST',
      body: new URLSearchParams({
        acao: 'uploadArquivoAluno',
        email: usuario.email,
        nomeArquivo: file.name,
        tipoArquivo: file.type,
        conteudo: base64
      })
    })
    .then(r => r.json())
    .then(res => {
      if (res.status === 'sucesso') {
        alert('Arquivo enviado com sucesso');
        input.value = '';
      } else {
        alert(res.msg);
      }
    })
    .catch(() => alert('Erro ao enviar arquivo'));
  };

  reader.readAsDataURL(file);
}

	function abrirModalTrocarSenha() {
  document.getElementById('senhaAtual').value = '';
  document.getElementById('novaSenha').value = '';
  document.getElementById('modalTrocarSenha').style.display = 'block';
}

function fecharModalTrocarSenha() {
  document.getElementById('modalTrocarSenha').style.display = 'none';
}

function trocarSenha() {
  const usuario = JSON.parse(localStorage.getItem('usuario'));

  const senhaAtual = document.getElementById('senhaAtual').value.trim();
  const novaSenha = document.getElementById('novaSenha').value.trim();

  if (!senhaAtual || !novaSenha) {
    alert('Preencha todos os campos');
    return;
  }

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'trocarSenha',
      email: usuario.email,
      senhaAtual: senhaAtual,
      novaSenha: novaSenha
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'sucesso') {
      alert(res.msg);
      fecharModalTrocarSenha();
    } else {
      alert(res.msg);
    }
  })
  .catch(() => {
    alert('Erro ao trocar senha');
  });
}

	let pastaAtualId = '';

function abrirModalArquivosAluno() {
  if (!window.pastaDriveAluno) {
    alert('Pasta do aluno nÃ£o encontrada');
    return;
  }

  const match = window.pastaDriveAluno.match(/[-\w]{25,}/);
  pastaAtualId = match ? match[0] : '';

  document.getElementById('modalArquivos').style.display = 'block';
  listarArquivos();
}

function fecharModalArquivos() {
  document.getElementById('modalArquivos').style.display = 'none';
}

function listarArquivos() {
  document.getElementById('conteudoArquivos').innerHTML = 'Carregando...';

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'listarArquivosAluno',
      pastaId: pastaAtualId
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso') {
      document.getElementById('conteudoArquivos').innerText = 'Erro ao carregar arquivos';
      return;
    }

    if (res.dados.length === 0) {
      document.getElementById('conteudoArquivos').innerText = 'Nenhum arquivo enviado.';
      return;
    }

    let html = '<ul>';

    res.dados.forEach(a => {
      const downloadUrl =
        `https://drive.google.com/uc?export=download&id=${a.id}`;

      html += `
        <li>
          ðŸ“„ ${a.nome}<br>
          <a href="${a.url}" target="_blank">Abrir</a> |
          <a href="${downloadUrl}" target="_blank">Download</a> |
          <a href="#" onclick="excluirArquivo('${a.id}')">Excluir</a>
        </li><br>
      `;
    });

    html += '</ul>';

    document.getElementById('conteudoArquivos').innerHTML = html;
  })
  .catch(() => {
    document.getElementById('conteudoArquivos').innerText = 'Erro ao carregar arquivos';
  });
}

function enviarArquivo() {
  const input = document.getElementById('arquivoUpload');
  const file = input.files[0];

  if (!file) {
    alert('Selecione um arquivo');
    return;
  }

  const reader = new FileReader();

  reader.onload = function () {
    const base64 = reader.result.split(',')[1];

    fetch(API_URL, {
      method: 'POST',
      body: new URLSearchParams({
        acao: 'uploadArquivoAluno',
        email: usuario.email,
        nomeArquivo: file.name,
        tipoArquivo: file.type,
        conteudo: base64
      })
    })
    .then(r => r.json())
    .then(res => {
      if (res.status === 'sucesso') {
        input.value = '';
        listarArquivos();
      } else {
        alert(res.msg);
      }
    })
    .catch(() => alert('Erro ao enviar arquivo'));
  };

  reader.readAsDataURL(file);
}

	function excluirArquivo(arquivoId) {
  if (!confirm('Deseja excluir este arquivo?')) return;

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'excluirArquivoAluno',
      arquivoId: arquivoId
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'sucesso') {
      listarArquivos();
    } else {
      alert(res.msg);
    }
  })
  .catch(() => alert('Erro ao excluir arquivo'));
}

	document.getElementById('foto').addEventListener('change', function(e){
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(){
    document.getElementById('preview').src = reader.result;
  };
  reader.readAsDataURL(file);
});
	
</script>

		<!-- Modal Trocar Senha -->
<div id="modalTrocarSenha" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModalTrocarSenha()">&times;</span>

    <h2>Trocar senha</h2>

    <div class="field">
      <label>Senha atual</label>
      <input type="password" id="senhaAtual" />
    </div>

    <div class="field">
      <label>Nova senha</label>
      <input type="password" id="novaSenha" />
    </div>

    <br>
    <button class="button primary" onclick="trocarSenha()">Salvar</button>
    <button class="button" onclick="fecharModalTrocarSenha()">Cancelar</button>
  </div>
</div>

		<!-- Modal Arquivos do Aluno -->
<div id="modalArquivos" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModalArquivos()">&times;</span>

    <h2>Meus arquivos</h2>

    <!-- Upload -->
    <div class="field">
      <input type="file" id="arquivoUpload" />
      <button class="button small" onclick="enviarArquivo()">Enviar arquivo</button>
    </div>

    <hr>

    <div id="conteudoArquivos">Carregando arquivos...</div>

    <br>
    <button class="button" onclick="fecharModalArquivos()">Fechar</button>
  </div>
</div>


	</body>
</html>
