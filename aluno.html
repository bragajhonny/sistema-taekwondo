<!DOCTYPE HTML>
<html>
	<head>
		<title>Painel do Aluno - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

		<script>
			const usuario = JSON.parse(localStorage.getItem('usuario'));

			if (!usuario || usuario.tipo !== 'aluno') {
  				window.location.href = 'index.html';
			}
		</script>

	</head>

	<body class="is-preload">
	<!-- Wrapper -->
	<div id="wrapper">
		<!-- Header -->
		<header id="header">
			<div class="inner">
				<!-- Logo -->
				<a href="index.html" class="logo">
					<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
				</a>
			</div>

			<!-- Nav -->
			<nav>
				<ul>
					<li><a href="#menu">Menu</a></li>
				</ul>
			</nav>
		</header>

		<!-- Menu -->
		<nav id="menu">
			<h2>Menu</h2>
			<ul>
				<li><a href="historico-aluno.html">HistÃ³rico de presenÃ§a</a></li>
				<li><a href="#" onclick="abrirModalTrocarSenha()">Trocar senha</a></li>
				<input type="button" value="Sair" class="primary" onclick="logout()" />
			</ul>
		</nav>

		<!-- Main -->
		<div id="main">
			<div class="inner">
				<h1>Painel do Aluno</h1>
				<div class="perfil-aluno">
				  <img id="fotoTopoAluno" alt="Foto do aluno">
				  <h3 id="nomeTopoAluno"></h3>
				</div>

						
				<table>
					<tbody>
						<tr>
							<td>Nome</td>
							<td><input type="text" id="nome" placeholder="Nome"></td>
						</tr>
						<tr>
							<td>Data de nascimento</td>
							<td><input type="text" id="dataNascimento"></td>
						</tr>
						<tr>
							<td>Sexo</td>
							<td><input type="text" id="sexo"></td>
						</tr>
						<tr>
							<td>Telefone</td>
							<td><input type="text" id="telefone"></td>
						</tr>
						<tr>
							<td>EndereÃ§o</td>
							<td><input type="text" id="endereco" placeholder="EndereÃ§o"></td>
						</tr>
						<tr>
							<td>Tipo Sanguineo</td>
							<td><input type="text" id="tipoSanguineo"></td>
						</tr>
						<tr>
							<td>RG</td>
							<td><input type="text" id="rg" placeholder="RG" ></td>
						</tr>
						<tr>
							<td>CPF</td>
							<td><input type="text" id="cpf" placeholder="CPF" ></td>
						</tr>
						<tr>
							<td>E-mail</td>
							<td><input type="text" id="email" disabled></td>
						</tr>
						<tr>
							<td>Faixa</td>
							<td><input type="text" id="faixa" disabled></td>
						</tr>
					</tbody>
				</table>
				<ul class="actions">
					<li><input type="button" value="Salvar alteraÃ§Ãµes" class="primary" onclick="salvarDados()" /></li>
					<li><input type="button" value="Minha pasta" onclick="window.open(window.pastaDriveAluno, '_blank')" /></li>
					<li><input type="button" value="Documentos" onclick="abrirModalArquivosAluno()" /> </li>
				</ul>
			</div>
		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = 'https://script.google.com/macros/s/AKfycbwjK_OWQlJqp_mmNgvR6OSeWPQysNIakJtPWV366oSGvsUtDj0OrHB_hPIYUqxpanlW_Q/exec';
let pastaAtualId = '';

	function mascaraData(input) {
  input.addEventListener('input', () => {
    let valor = input.value.replace(/\D/g, '');

    if (valor.length > 8) valor = valor.slice(0, 8);

    if (valor.length >= 5) {
      input.value = valor.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
    } else if (valor.length >= 3) {
      input.value = valor.replace(/(\d{2})(\d{0,2})/, '$1/$2');
    } else {
      input.value = valor;
    }
  });
}


/* =========================
   INIT
========================= */
document.addEventListener('DOMContentLoaded', initAluno);

function initAluno() {
  carregarAluno();
  configurarEventos();

const fotoTopo = document.getElementById('fotoTopoAluno');

if (a.fotoPerfil) {
  fotoTopo.src = a.fotoPerfil;
} else {
  fotoTopo.src = 'images/foto-padrao.png';
}

}

/* =========================
   EVENTOS
========================= */
function configurarEventos() {
  const foto = document.getElementById('fotoPerfil');
  if (foto) {
    foto.addEventListener('change', previewFoto);
  }

  const dataNasc = document.getElementById('dataNascimento');
  if (dataNasc) {
    mascaraData(dataNasc);
  }
}


/* =========================
   ALUNO
========================= */
function carregarAluno() {
  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'buscarAluno',
      email: usuario.email
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso') {
      alert(res.msg);
      return;
    }

    const a = res.dados;

    nome.value = a.nome || '';
    dataNascimento.value = formatarDataBR(a.dataNascimento);
    sexo.value = a.sexo || '';
    telefone.value = a.telefone || '';
    endereco.value = a.endereco || '';
    tipoSanguineo.value = a.tipoSanguineo || '';
    rg.value = a.rg || '';
    cpf.value = a.cpf || '';
    email.value = a.email || '';
    faixa.value = a.faixa || 'NÃ£o definida';

    window.pastaDriveAluno = a.pastaDrive || '';

    // FOTO NO TOPO
	const fotoTopo = document.getElementById('fotoTopoAluno');
	const nomeTopo = document.getElementById('nomeTopoAluno');
	
	nomeTopo.innerText = a.nome || '';
	
	if (a.fotoPerfil) {
	  fotoTopo.src = a.fotoPerfil;
	  previewFotoBase64(a.fotoPerfil);
	}

  })
  .catch(() => alert('Erro ao carregar dados do aluno'));
}

function salvarDados() {
	if (dataNascimento.value.length !== 10) {
  		alert('Data de nascimento invÃ¡lida');
	  return;
	}

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'atualizarAluno',
      email: usuario.email,
      nome: nome.value,
      dataNascimento: dataBRParaISO(dataNascimento.value),
      sexo: sexo.value,
      telefone: telefone.value,
      endereco: endereco.value,
      tipoSanguineo: tipoSanguineo.value,
      rg: rg.value,
      cpf: cpf.value
    })
  })
  .then(r => r.json())
  .then(res => alert(res.msg || 'Dados salvos'))
  .catch(() => alert('Erro ao salvar dados'));
}

/* =========================
   FOTO PERFIL
========================= */
function previewFoto(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => previewFotoBase64(reader.result);
  reader.readAsDataURL(file);
}

function previewFotoBase64(base64) {
  const imgModal = document.getElementById('previewFoto');
  if (imgModal) {
    imgModal.src = base64;
    imgModal.style.display = 'block';
  }

  const imgTopo = document.getElementById('fotoTopoAluno');
  if (imgTopo) {
    imgTopo.src = base64;
  }
}

function enviarFotoPerfil() {
  const input = document.getElementById('fotoPerfil');
  const file = input.files[0];

  if (!file) {
    alert('Selecione uma foto');
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    fetch(API_URL, {
      method: 'POST',
      body: new URLSearchParams({
        acao: 'uploadFotoPerfilAluno',
        email: usuario.email,
        imagem: reader.result
      })
    })
    .then(r => r.json())
    .then(res => alert(res.msg))
    .catch(() => alert('Erro ao enviar foto'));
  };

  reader.readAsDataURL(file);
}

/* =========================
   ARQUIVOS
========================= */
function abrirModalArquivosAluno() {
  if (!window.pastaDriveAluno) {
    alert('Pasta nÃ£o encontrada');
    return;
  }

  const match = window.pastaDriveAluno.match(/[-\w]{25,}/);
  pastaAtualId = match ? match[0] : '';

  modalArquivos.style.display = 'block';
  listarArquivos();
}

function listarArquivos() {
  conteudoArquivos.innerHTML = 'Carregando...';

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'listarArquivosAluno',
      pastaId: pastaAtualId
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso' || !res.dados.length) {
      conteudoArquivos.innerText = 'Nenhum arquivo encontrado.';
      return;
    }

    conteudoArquivos.innerHTML = `
      <ul>
        ${res.dados.map(a => `
          <li>
            ðŸ“„ ${a.nome}<br>
            <a href="${a.url}" target="_blank">Abrir</a> |
            <a href="https://drive.google.com/uc?export=download&id=${a.id}" target="_blank">Download</a> |
            <a href="#" onclick="excluirArquivo('${a.id}')">Excluir</a>
          </li><br>
        `).join('')}
      </ul>
    `;
  });
}

function enviarArquivo() {
  const file = arquivoUpload.files[0];
  if (!file) return alert('Selecione um arquivo');

  const reader = new FileReader();
  reader.onload = () => {
    fetch(API_URL, {
      method: 'POST',
      body: new URLSearchParams({
        acao: 'uploadArquivoAluno',
        email: usuario.email,
        nomeArquivo: file.name,
        tipoArquivo: file.type,
        conteudo: reader.result.split(',')[1]
      })
    })
    .then(() => listarArquivos());
  };
  reader.readAsDataURL(file);
}

function excluirArquivo(id) {
  if (!confirm('Excluir arquivo?')) return;

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'excluirArquivoAluno',
      arquivoId: id
    })
  })
  .then(() => listarArquivos());
}

/* =========================
   MODAIS / CONTA
========================= */
function abrirModalTrocarSenha() {
  modalTrocarSenha.style.display = 'block';
}

function fecharModalTrocarSenha() {
  modalTrocarSenha.style.display = 'none';
}

function fecharModalArquivos() {
  modalArquivos.style.display = 'none';
}

function trocarSenha() {
  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'trocarSenha',
      email: usuario.email,
      senhaAtual: senhaAtual.value,
      novaSenha: novaSenha.value
    })
  })
  .then(r => r.json())
  .then(res => alert(res.msg));
}

function formatarDataBR(dataISO) {
  if (!dataISO) return '';

  const data = new Date(dataISO);
  const dia = String(data.getDate()).padStart(2, '0');
  const mes = String(data.getMonth() + 1).padStart(2, '0');
  const ano = data.getFullYear();

  return `${dia}/${mes}/${ano}`;
}

function dataBRParaISO(dataBR) {
  if (!dataBR) return '';
  const [dia, mes, ano] = dataBR.split('/');
  return `${ano}-${mes}-${dia}`;
}

/* =========================
   LOGOUT
========================= */
function logout() {
  localStorage.removeItem('usuario');
  window.location.href = 'index.html';
}
	
</script>

<!-- Modal Trocar Senha e Foto -->
<div id="modalTrocarSenha" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModalTrocarSenha()">&times;</span>

    <h2>Conta do aluno</h2>

    <h3>Foto de perfil</h3>
    <input type="file" id="fotoPerfil" accept="image/*">
    <br><br>
    <img id="previewFoto" style="max-width:120px;border-radius:50%;display:none;">
    <br>
    <button class="button small" onclick="enviarFotoPerfil()">Salvar foto</button>

    <hr>

    <h3>Trocar senha</h3>
    <div class="field">
      <label>Senha atual</label>
      <input type="password" id="senhaAtual" />
    </div>

    <div class="field">
      <label>Nova senha</label>
      <input type="password" id="novaSenha" />
    </div>

    <br>
    <button class="button primary small" onclick="trocarSenha()">Salvar senha</button>
    <button class="button small" onclick="fecharModalTrocarSenha()">Cancelar</button>
  </div>
</div>


<!-- Modal Arquivos do Aluno -->
<div id="modalArquivos" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModalArquivos()">&times;</span>

    <h2>Meus arquivos</h2>

    <!-- Upload -->
    <div class="field">
      <input type="file" id="arquivoUpload" />
      <button class="button small" onclick="enviarArquivo()">Enviar arquivo</button>
    </div>

    <hr>

    <div id="conteudoArquivos">Carregando arquivos...</div>

    <br>
    <button class="button" onclick="fecharModalArquivos()">Fechar</button>
  </div>
</div>


	</body>
</html>
