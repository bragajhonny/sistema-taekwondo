<!DOCTYPE HTML>
<html>
<head>
  <title>Editar dados - CT Gerivaldo Silva</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
</head>

<body class="is-preload">
<div id="wrapper">

  <!-- HEADER -->
  <header id="header">
    <div class="inner">
      <a href="perfil.html" class="logo">
        <span class="symbol"><img src="images/logo.svg" alt="" /></span>
        <span class="title">CT Gerivaldo Silva</span>
      </a>
    </div>
  </header>

  <!-- MAIN -->
  <div id="main">
    <div class="inner">

      <h2>Editar dados</h2>

      <!-- FOTO -->
      <section style="text-align:center">
        <img id="fotoPerfil"
             src="images/foto-padrao.png"
             class="foto-perfil"
             style="cursor:pointer"
             title="Clique para alterar a foto">

        <input type="file" id="inputFoto" accept="image/*" style="display:none">
      </section>

      <hr>

      <!-- FORM -->
      <section>
        <form onsubmit="return false">

          <div class="fields">
            <div class="field">
              <label>Nome</label>
              <input type="text" id="nome">
            </div>

            <div class="field half">
              <label>Data de nascimento</label>
              <input type="date" id="dataNascimento">
            </div>

            <div class="field half">
              <label>Sexo</label>
              <select id="sexo">
                <option value="">Selecione</option>
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
              </select>
            </div>

            <div class="field half">
              <label>Telefone</label>
              <input type="text" id="telefone">
            </div>

            <div class="field half">
              <label>Tipo sanguíneo</label>
              <input type="text" id="tipoSanguineo">
            </div>

            <div class="field">
              <label>Endereço</label>
              <input type="text" id="endereco">
            </div>
          </div>

          <ul class="actions">
            <li>
              <input type="button" value="Salvar alterações" class="primary" onclick="salvarDados()">
            </li>
            <li>
              <input type="button" value="Trocar senha" onclick="trocarSenha()">
            </li>
          </ul>

        </form>
      </section>

    </div>
  </div>

</div>

<!-- SCRIPTS -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/main.js"></script>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwhCJ6yA6gPH8kvrH-jyTeLbDDfxKJ_kFA-61r3XPcJIuJlpU3v0978y5qf7BwnLi4yIQ/exec';

const usuario = JSON.parse(localStorage.getItem('usuario'));
if (!usuario) location.href = 'index.html';

/* =========================
   INIT
========================= */
document.addEventListener('DOMContentLoaded', () => {
  carregarDados();
  configurarFoto();
});

/* =========================
   CARREGAR DADOS
========================= */
function carregarDados() {
  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'buscarAluno',
      email: usuario.email
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso') return;

    const u = res.dados;

    nome.value = u.nome || '';
    dataNascimento.value = u.dataNascimento || '';
    sexo.value = u.sexo || '';
    telefone.value = u.telefone || '';
    endereco.value = u.endereco || '';
    tipoSanguineo.value = u.tipoSanguineo || '';

    if (u.fotoPerfil) {
      fotoPerfil.src = `https://drive.google.com/uc?export=view&id=${u.fotoPerfil}`;
    }
  });
}

/* =========================
   SALVAR
========================= */
function salvarDados() {
  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'atualizarAluno',
      email: usuario.email,
      nome: nome.value,
      dataNascimento: dataNascimento.value,
      sexo: sexo.value,
      telefone: telefone.value,
      endereco: endereco.value,
      tipoSanguineo: tipoSanguineo.value
    })
  })
  .then(r => r.json())
  .then(res => {
    alert(res.msg || 'Dados salvos');
    location.href = 'perfil.html';
  });
}

/* =========================
   FOTO
========================= */
function configurarFoto() {
  fotoPerfil.onclick = () => inputFoto.click();

  inputFoto.onchange = () => {
    const file = inputFoto.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      fetch(API_URL, {
        method: 'POST',
        body: new URLSearchParams({
          acao: 'uploadFotoPerfil',
          email: usuario.email,
          tipo: usuario.tipo,
          imagem: reader.result
        })
      })
      .then(r => r.json())
      .then(() => {
        fotoPerfil.src = reader.result;
      });
    };
    reader.readAsDataURL(file);
  };
}

/* =========================
   SENHA
========================= */
function trocarSenha() {
  const atual = prompt('Senha atual:');
  const nova = prompt('Nova senha:');
  if (!atual || !nova) return;

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'trocarSenha',
      email: usuario.email,
      senhaAtual: atual,
      novaSenha: nova
    })
  })
  .then(r => r.json())
  .then(res => alert(res.msg));
}
</script>

</body>
</html>
