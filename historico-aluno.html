<!DOCTYPE HTML>
<html>
	<head>
		<title>Histórico de Presença - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

		<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  		<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  		<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
	</head>

	<body class="is-preload">
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Header -->
			<header id="header">
				<div class="inner">
					<!-- Logo -->
					<a href="index.html" class="logo">
						<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>
				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					<li><a href="professor.html">Painel do professor</a></li>
					<li><a href="presenca.html">Presença</a></li>
					<li><a href="historico-aluno.html">Histórico de presença</a></li>
					<input type="button" value="Sair" class="primary" onclick="logout()" />
				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">
					<h1>Histórico de presença</h1>
					<select id="dataPresenca"> <option value="">Carregando datas...</option> </select>
					<br />

					<h3>Alunos Presentes</h3>

            				<ul id="listaAlunos">
                				<li>Selecione uma data</li>
            				</ul>

            				<ul class="actions">
               					<li><input type="button" value="Voltar" class="primary" onclick="history.back()"/></li>
            				</ul>
				</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

  <script>
/* ========== FIREBASE ========== */

const firebaseConfig = {
    apiKey: "AIzaSyDTcmFtCpgb-krAJ6OniJSXIXnkoxGzWF4",
    authDomain: "sistema-taekwondo-1.firebaseapp.com",
    projectId: "sistema-taekwondo-1",
    messagingSenderId: "635745416768",
    appId: "1:635745416768:web:58d23eca722878f047d1a5"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db   = firebase.firestore();

/* ========== INICIALIZAÇÃO ========== */

document.addEventListener("DOMContentLoaded", () => {
    carregarDatas();
    document.getElementById("dataPresenca").addEventListener("change", carregarPresenca);
});

/* ========== FUNÇÕES ========== */

// Buscar datas da coleção presencas
function carregarDatas() {
    const select = document.getElementById("dataPresenca");
    select.innerHTML = `<option value="">Selecione a data</option>`;

    db.collection("presencas")
        .orderBy("data", "desc")
        .get()
        .then(snapshot => {
            if (snapshot.empty) {
                select.innerHTML = `<option value="">Nenhuma data encontrada</option>`;
                return;
            }

            snapshot.forEach(doc => {
                const option = document.createElement("option");
                option.value = doc.id; // YYYY-MM-DD
                option.textContent = doc.id;
                select.appendChild(option);
            });
        });
}

// Buscar presença da data selecionada
function carregarPresenca() {
    const data = document.getElementById("dataPresenca").value;
    const lista = document.getElementById("listaAlunos");

    lista.innerHTML = "";

    if (!data) {
        lista.innerHTML = "<li>Selecione uma data</li>";
        return;
    }

    db.collection("presencas").doc(data).get()
        .then(doc => {
            if (!doc.exists) {
                lista.innerHTML = "<li>Nenhum registro encontrado</li>";
                return;
            }

            const registros = doc.data().registros;

            const alunosPresentesIds = Object.keys(registros)
                .filter(alunoId => registros[alunoId] === true);

            if (alunosPresentesIds.length === 0) {
                lista.innerHTML = "<li>Nenhum aluno presente nessa data</li>";
                return;
            }

            const promessas = alunosPresentesIds.map(alunoId =>
                db.collection("alunos").doc(alunoId).get()
                    .then(doc => doc.exists ? doc.data().nome : null)
            );

            Promise.all(promessas).then(nomes => {
                // Remove nulos e ordena A → Z
                nomes
                    .filter(nome => nome)
                    .sort((a, b) => a.localeCompare(b, 'pt-BR'))
                    .forEach(nome => {
                        const li = document.createElement("li");
                        li.textContent = nome;
                        lista.appendChild(li);
                    });
            });
        })
        .catch(err => {
            console.error(err);
            lista.innerHTML = "<li>Erro ao carregar presença</li>";
        });
}


</script>

	</body>
</html>
