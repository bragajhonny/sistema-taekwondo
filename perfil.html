<!DOCTYPE HTML>
<html>
  <head>
		<title>Painel do usuário - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
  
<body>
  <div id="wrapper">
    <header id="header">
      <div class="inner">
        <a href="perfil.html" class="logo">
          <span class="symbol"><img src="images/logo.svg" alt="" /></span>
          <span class="title">CT Gerivaldo Silva</span>
        </a>
      </div>
      
      <nav>
        <ul>
          <li><a href="#menu">Menu</a></li>
        </ul>
    </nav>
    </header>

  <!-- MENU -->
  <nav id="menu">
    <h2>Menu</h2>
    <ul id="menuLinks"></ul>
    
    <input type="button" value="Sair" class="primary" onclick="logout()" />
  </nav>

  <!-- MAIN -->
  <div id="main">
    <div class="inner">
		
		<section style="text-align:center">
		  <div id="fotoPerfil"
		       style="
		         width: 150px;
		         height: 150px;
		         border-radius: 50%;
		         margin: 0 auto 10px;
		         background-size: cover;
		         background-position: center;
		         background-repeat: no-repeat;
		         background-color: #ddd;
		       ">
		  </div>
		  <h2 id="nomeUsuario">Carregando...</h2>
		</section>


      <hr>

      <!-- FICHA -->
      <section>
        <h3>Ficha cadastral</h3>

        <table>
          <tbody>
            <tr><td>Nome</td><td id="f_nome"></td></tr>
            <tr><td>Data de nascimento</td><td id="f_dataNascimento"></td></tr>
            <tr><td>Sexo</td><td id="f_sexo"></td></tr>
            <tr><td>Telefone</td><td id="f_telefone"></td></tr>
            <tr><td>Endereço</td><td id="f_endereco"></td></tr>
            <tr><td>Tipo sanguíneo</td><td id="f_tipoSanguineo"></td></tr>
            <tr><td>E-mail</td><td id="f_email"></td></tr>
            <tr id="linhaFaixa"><td>Faixa</td><td id="f_faixa"></td></tr>
          </tbody>
        </table>
      </section>

    </div>
  </div>

</div>

<!-- SCRIPTS BASE -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = 'https://script.google.com/macros/s/AKfycbyHeniztA9TghTkzgJDXgwAcYiAFyFyx8Abewk8k8ORhYOhm9rQqeHjZGBjyln_U5UQGA/exec';

const usuario = JSON.parse(localStorage.getItem('usuario'));
if (!usuario) {
  window.location.href = 'index.html';
}

/* =========================
   INIT
========================= */
document.addEventListener('DOMContentLoaded', () => {
  configurarMenu();
  carregarUsuario();
});

/* =========================
   MENU DINÂMICO
========================= */
			function configurarMenu() {
				  const menu = document.getElementById('menuLinks');
				  menu.innerHTML = '';
				
				  menu.innerHTML += `<li><a href="perfil.html">Meu perfil</a></li>`;
				  menu.innerHTML += `<li><a href="editar-dados.html">Editar dados</a></li>`;
					menu.innerHTML += `<li><a href="historico-aluno.html">Histórico de presença</a></li>`;
				
				  if (usuario.tipo === 'professor') {
				    menu.innerHTML += `<li><a href="presenca.html">Presença</a></li>
				    <li><a href="professor.html">Painel do professor</a></li>
				    `;
				  }
				}

/* =========================
   CARREGAR DADOS
========================= */
function carregarUsuario() {
	fetch(API_URL, {
	  method: 'POST',
	  body: new URLSearchParams({
	    acao: 'buscarUsuario',
	    email: usuario.email
	  })
	})
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso') {
      alert(res.msg);
      return;
    }

    const u = res.dados;
	  
	usuario.tipo = u.tipo;
	usuario.idUsuario = u.idUsuario;
	localStorage.setItem('usuario', JSON.stringify(usuario));

    nomeUsuario.innerText = u.nome || '';

    document.getElementById('f_nome').innerText = u.nome || '-';
    document.getElementById('f_dataNascimento').innerText = formatarDataBR(u.dataNascimento);
    document.getElementById('f_sexo').innerText = u.sexo || '-';
    document.getElementById('f_telefone').innerText = u.telefone || '-';
    document.getElementById('f_endereco').innerText = u.endereco || '-';
    document.getElementById('f_tipoSanguineo').innerText = u.tipoSanguineo || '-';
    document.getElementById('f_email').innerText = u.email || '-';

    if (u.tipo === 'aluno') {
	  document.getElementById('f_faixa').innerText = u.faixa || '-';
	} else {
	  document.getElementById('linhaFaixa').style.display = 'none';
	}
	console.log('ID fotoPerfil recebido:', u.fotoPerfil);
    
	const foto = document.getElementById('fotoPerfil');
	foto.style.backgroundImage = `url('${linkDriveParaImagem(u.fotoPerfil)}')`;

	configurarMenu();
  })
  .catch(() => alert('Erro ao carregar perfil'));
}

/* =========================
   UTIL
========================= */
function linkDriveParaImagem(valor) {
  if (!valor) return 'images/foto-padrao.png';

  const id = String(valor).trim();
  return `https://lh3.googleusercontent.com/d/${id}`;
}



function formatarDataBR(dataISO) {
	if (!dataISO) return '-';
	const d = new Date(dataISO);
	return d.toLocaleDateString('pt-BR');
}

/* =========================
   LOGOUT
========================= */
function logout() {
  localStorage.removeItem('usuario');
  window.location.href = 'index.html';
}

</script>

</body>
</html>
