<!DOCTYPE HTML>
<html>
	<head>
		<title>Editar dados - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

		<script>
			const usuario = JSON.parse(localStorage.getItem('usuario'));
			
			if (!usuario || (usuario.tipo !== 'aluno' && usuario.tipo !== 'professor')) {
				window.location.href = 'index.html';
			}
		</script>

	</head>

	<body class="is-preload">
	<!-- Wrapper -->
	<div id="wrapper">
		<!-- Header -->
		<header id="header">
			<div class="inner">
				<!-- Logo -->
				<a href="index.html" class="logo">
					<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
				</a>
			</div>

			<!-- Nav -->
			<nav>
				<ul>
					<li><a href="#menu">Menu</a></li>
				</ul>
			</nav>
		</header>

		<!-- Menu -->
		<nav id="menu">
			<h2>Menu</h2>
			<ul>
				<input type="button" value="Sair" class="primary" onclick="logout()" />
			</ul>
		</nav>

		<!-- Main -->
		<div id="main">
			<div class="inner">
				<h1>Editar dados</h1>
				<div>
					<div class="perfil-aluno">
					  <img id="fotoTopoUsuario"
					       alt="Foto do usuÃ¡rio"
					       style="width:120px;height:120px;border-radius:50%;object-fit:cover;cursor:pointer"
					       onclick="document.getElementById('fotoPerfil').click()">
					
					  <h3 id="nomeTopoUsuario"></h3>
					
					  <!-- INPUT INVISÃVEL (OBRIGATÃ“RIO) -->
					  <input type="file"
					         id="fotoPerfil"
					         accept="image/*"
					         style="display:none">
					</div>
				</div>

				<table>
					<tbody>
						<tr>
							<td>Nome</td>
							<td><input type="text" id="nome" placeholder="Nome"></td>
						</tr>
						<tr>
							<td>Data de nascimento</td>
							<td><input type="text" id="dataNascimento"></td>
						</tr>
						<tr>
							<td>Sexo</td>
							<td><input type="text" id="sexo"></td>
						</tr>
						<tr>
							<td>Telefone</td>
							<td><input type="text" id="telefone"></td>
						</tr>
						<tr>
							<td>EndereÃ§o</td>
							<td><input type="text" id="endereco" placeholder="EndereÃ§o"></td>
						</tr>
						<tr>
							<td>Tipo Sanguineo</td>
							<td><input type="text" id="tipoSanguineo"></td>
						</tr>
						<tr>
							<td>RG</td>
							<td><input type="text" id="rg" placeholder="RG" ></td>
						</tr>
						<tr>
							<td>CPF</td>
							<td><input type="text" id="cpf" placeholder="CPF" ></td>
						</tr>
						<tr>
							<td>E-mail</td>
							<td><input type="text" id="email" disabled></td>
						</tr>
						<tr>
							<td>Faixa</td>
							<td><input type="text" id="faixa" disabled></td>
						</tr>
					</tbody>
				</table>
				<ul class="actions">
					<li><input type="button" value="Salvar alteraÃ§Ãµes" class="primary" onclick="salvarDados()" /></li>
					<li><input type="button" value="Minha pasta" onclick="window.open(window.pastaDriveUsuario, '_blank')" /></li>
					<li><input type="button" value="Documentos" onclick="abrirModalArquivos()" /> </li>
				</ul>
			</div>
		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

			<script>
			/* =========================
			   CONFIG
			========================= */
			const API_URL = 'https://script.google.com/macros/s/AKfycbyn_yp1gpwMPUS8ewzfOJQVHOxh_NwoDrdHSQ4NRWCr9TN840bQjLop8MCKEKZyhXBnwA/exec';
			let pastaAtualId = '';
			
				function mascaraData(input) {
			  input.addEventListener('input', () => {
			    let valor = input.value.replace(/\D/g, '');
			
			    if (valor.length > 8) valor = valor.slice(0, 8);
			
			    if (valor.length >= 5) {
			      input.value = valor.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
			    } else if (valor.length >= 3) {
			      input.value = valor.replace(/(\d{2})(\d{0,2})/, '$1/$2');
			    } else {
			      input.value = valor;
			    }
			  });
			}
			
			
			/* =========================
			   INIT
			========================= */
			document.addEventListener('DOMContentLoaded', init);
			
			function init() {
			  carregarDados();
			  configurarEventos();
			}
			/* =========================
			   EVENTOS
			========================= */
			function configurarEventos() {
			  const foto = document.getElementById('fotoPerfil');
			  if (foto) {
			    foto.addEventListener('change', previewFoto);
			  }
			
			  const dataNasc = document.getElementById('dataNascimento');
			  if (dataNasc) {
			    mascaraData(dataNasc);
			  }
			}
			
			function linkDriveParaImagem(idOuUrl) {
			  if (!idOuUrl) return '';
			
			  let id = idOuUrl;
			
			  // Se vier URL, extrai o ID
			  if (idOuUrl.startsWith('http')) {
			    const match = idOuUrl.match(/[-\w]{25,}/);
			    if (!match) return '';
			    id = match[0];
			  }
			
			  // Link direto de imagem do Google
			  return `https://lh3.googleusercontent.com/d/${id}`;
			}
			
			/* =========================
			   USUARIO
			========================= */
			function carregarDados() {
			  const acao = usuario.tipo === 'aluno' ? 'buscarAluno' : 'buscarProfessor';
			
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: acao,
			      email: usuario.email
			    })
			  })
			  .then(r => r.json())
			  .then(res => {
			    if (res.status !== 'sucesso') {
			      alert(res.msg);
			      return;
			    }
			
			    const d = res.dados;
			
			    nome.value = d.nome || '';
			    dataNascimento.value = formatarDataBR(d.dataNascimento);
			    sexo.value = d.sexo || '';
			    telefone.value = d.telefone || '';
			    endereco.value = d.endereco || '';
			    tipoSanguineo.value = d.tipoSanguineo || '';
			    rg.value = d.rg || '';
			    cpf.value = d.cpf || '';
			    email.value = d.email || '';
			
			    faixa.value = d.faixa || '';
			
			    window.pastaDriveUsuario = d.pastaDrive || '';
			
			    nomeTopoUsuario.innerText = d.nome || '';
			
			    if (d.fotoPerfil) {
			      fotoTopoUsuario.src = linkDriveParaImagem(d.fotoPerfil);
			    } else {
			      fotoTopoUsuario.src = 'images/foto-padrao.png';
			    }
			  });
				if (usuario.tipo !== 'aluno') {
				  document.getElementById('faixa').closest('tr').style.display = 'none';
				}
			
			}
			
			function salvarDados() {
				if (dataNascimento.value.length !== 10) {
			  		alert('Data de nascimento invÃ¡lida');
				  return;
				}
			
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: usuario.tipo === 'aluno' ? 'atualizarAluno' : 'atualizarProfessor',
			      email: usuario.email,
			      nome: nome.value,
			      dataNascimento: dataBRParaISO(dataNascimento.value),
			      sexo: sexo.value,
			      telefone: telefone.value,
			      endereco: endereco.value,
			      tipoSanguineo: tipoSanguineo.value,
			      rg: rg.value,
			      cpf: cpf.value
			    })
			  })
			  .then(r => r.json())
			  .then(res => alert(res.msg || 'Dados salvos'))
			  .catch(() => alert('Erro ao salvar dados'));
			}
			
			/* =========================
			   FOTO PERFIL
			========================= */
			function previewFoto(e) {
			  const file = e.target.files[0];
			  if (!file) return;
			
			  const reader = new FileReader();
			  reader.onload = () => {
			    // Preview imediato
			    fotoTopoUsuario.src = reader.result;
			
			    // Envia para o servidor
			    enviarFotoPerfil(reader.result);
			  };
			  reader.readAsDataURL(file);
			}

			function previewFotoBase64(base64) {
			  const imgModal = document.getElementById('previewFoto');
			  if (imgModal) {
			    imgModal.src = base64;
			    imgModal.style.display = 'block';
			  }
			
			  const imgTopo = document.getElementById('fotoTopoUsuario');
			  if (imgTopo) {
			    imgTopo.src = base64;
			  }
			}
			
			function enviarFotoPerfil(base64) {
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'uploadFotoPerfil',
			      email: usuario.email,
			      tipo: usuario.tipo,
			      imagem: base64
			    })
			  })
			  .then(r => r.json())
			  .then(res => {
			    if (res.status !== 'sucesso') {
			      alert(res.msg || 'Erro ao salvar foto');
			    }
			  })
			  .catch(() => alert('Erro ao enviar foto'));
			}
			
			/* =========================
			   ARQUIVOS
			========================= */
			function abrirModalArquivos() {
			  if (!window.pastaDriveUsuario) {
			    alert('Pasta nÃ£o encontrada');
			    return;
			  }
			
			  const match = window.pastaDriveUsuario.match(/[-\w]{25,}/);
			  pastaAtualId = match ? match[0] : '';
			
			  modalArquivos.style.display = 'block';
			  listarArquivos();
			}
			
			function listarArquivos() {
			  conteudoArquivos.innerHTML = 'Carregando...';
			
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'listarArquivosUsuario',
			      pastaId: pastaAtualId
			    })
			  })
			  .then(r => r.json())
			  .then(res => {
			    if (res.status !== 'sucesso' || !res.dados.length) {
			      conteudoArquivos.innerText = 'Nenhum arquivo encontrado.';
			      return;
			    }
			
			    conteudoArquivos.innerHTML = `
			      <ul>
			        ${res.dados.map(a => `
			          <li>
			            ðŸ“„ ${a.nome}<br>
			            <a href="${a.url}" target="_blank">Abrir</a> |
			            <a href="https://drive.google.com/uc?export=download&id=${a.id}" target="_blank">Download</a> |
			            <a href="#" onclick="excluirArquivo('${a.id}')">Excluir</a>
			          </li><br>
			        `).join('')}
			      </ul>
			    `;
			  });
			}
			
			function enviarArquivo() {
			  const file = arquivoUpload.files[0];
			  if (!file) return alert('Selecione um arquivo');
			
			  const reader = new FileReader();
			  reader.onload = () => {
			    fetch(API_URL, {
			      method: 'POST',
			      body: new URLSearchParams({
			        acao: 'uploadArquivoUsuario',
			        email: usuario.email,
			        nomeArquivo: file.name,
			        tipoArquivo: file.type,
			        conteudo: reader.result.split(',')[1]
			      })
			    })
			    .then(() => listarArquivos());
			  };
			  reader.readAsDataURL(file);
			}
			
			function excluirArquivo(id) {
			  if (!confirm('Excluir arquivo?')) return;
			
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'excluirArquivoUsuario',
			      arquivoId: id
			    })
			  })
			  .then(() => listarArquivos());
			}
			
			/* =========================
			   MODAIS / CONTA
			========================= */
			function fecharModalArquivos() {
			  modalArquivos.style.display = 'none';
			}
			
			function trocarSenha() {
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'trocarSenha',
			      email: usuario.email,
			      senhaAtual: senhaAtual.value,
			      novaSenha: novaSenha.value
			    })
			  })
			  .then(r => r.json())
			  .then(res => alert(res.msg));
			}
			
			function formatarDataBR(dataISO) {
			  if (!dataISO) return '';
			
			  const data = new Date(dataISO);
			  const dia = String(data.getDate()).padStart(2, '0');
			  const mes = String(data.getMonth() + 1).padStart(2, '0');
			  const ano = data.getFullYear();
			
			  return `${dia}/${mes}/${ano}`;
			}
			
			function dataBRParaISO(dataBR) {
			  if (!dataBR) return '';
			  const [dia, mes, ano] = dataBR.split('/');
			  return `${ano}-${mes}-${dia}`;
			}
			
			/* =========================
			   LOGOUT
			========================= */
			function logout() {
			  localStorage.removeItem('usuario');
			  window.location.href = 'index.html';
			}
				
			</script>
			
			<!-- Modal Arquivos do Aluno -->
			<div id="modalArquivos" class="modal">
			  <div class="modal-content">
			    <span class="close" onclick="fecharModalArquivos()">&times;</span>
			
			    <h2>Meus arquivos</h2>
			
			    <!-- Upload -->
			    <div class="field">
			      <input type="file" id="arquivoUpload" />
			      <button class="button small" onclick="enviarArquivo()">Enviar arquivo</button>
			    </div>
			
			    <hr>
			
			    <div id="conteudoArquivos">Carregando arquivos...</div>
			
			    <br>
			    <button class="button" onclick="fecharModalArquivos()">Fechar</button>
			  </div>
			</div>


	</body>
</html>
