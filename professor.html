<!DOCTYPE HTML>
<html>
	<head>
		<title>Painel do Professor - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

		<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  		<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  		<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
	</head>

	<body class="is-preload">
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Header -->
			<header id="header">
				
				<div class="inner">
				<!-- Logo -->
					<a href="index.html" class="logo">
						<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>
				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					<li><a href="presenca.html">Presença</a></li>
					<li><a href="historico-aluno.html">Histórico de presença</a></li>
					<input type="button" value="Sair" class="primary" onclick="logout()" />
				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">
					<h1>Alunos cadastrados</h1>
					<table>
        					<thead>
          						<tr>
								<th>Nome</th>
								<th>Email</th>
								<th>Telefone</th>
								<th>Faixa</th>
								<th>Ações</th>
							</tr>
						</thead>
						<tbody id="listaAlunos"></tbody>
					</table>
				</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDTcmFtCpgb-krAJ6OniJSXIXnkoxGzWF4",
      authDomain: "sistema-taekwondo-1.firebaseapp.com",
      projectId: "sistema-taekwondo-1",
      messagingSenderId: "635745416768",
      appId: "1:635745416768:web:58d23eca722878f047d1a5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "index.html";

      db.collection("alunos").doc(user.uid).get()
        .then(doc => {
          if (!doc.exists || doc.data().perfil !== "professor") {
            alert("Acesso negado");
            window.location.href = "index.html";
            return;
          }
          carregarAlunos();
        });
    });

    function carregarAlunos() {
      db.collection("alunos")
        .where("perfil", "in", ["aluno", "professor"])
        .orderBy("nome")
        .get()
        .then(snapshot => {
          const tbody = document.getElementById("listaAlunos");
          tbody.innerHTML = "";

          if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='5'>Nenhum aluno cadastrado</td></tr>";
            return;
          }

          snapshot.forEach(doc => {
            const a = doc.data();
            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td>${a.nome}</td>
              <td>${a.email}</td>
              <td>${a.telefone || ""}</td>
              <td>
                <select id="faixa-${doc.id}">
                  <option value="">-- Selecione --</option>
                  <option value="branca" ${a.faixa==="branca"?"selected":""}>Branca</option>
                  <option value="branca/amarela" ${a.faixa==="branca/amarela"?"selected":""}>Branca/Amarela</option>
                  <option value="amarela" ${a.faixa==="amarela"?"selected":""}>Amarela</option>
                  <option value="amarela/verde" ${a.faixa==="amarela/verde"?"selected":""}>Amarela/Verde</option>
                  <option value="verde" ${a.faixa==="verde"?"selected":""}>Verde</option>
                  <option value="verde/azul" ${a.faixa==="verde/azul"?"selected":""}>Verde/Azul</option>
                  <option value="azul" ${a.faixa==="azul"?"selected":""}>Azul</option>
                  <option value="azul/vermelha" ${a.faixa==="azul/vermelha"?"selected":""}>Azul/Vermelha</option>
                  <option value="vermelha" ${a.faixa==="vermelha"?"selected":""}>Vermelha</option>
                  <option value="vermelha/preta" ${a.faixa==="vermelha/preta"?"selected":""}>Vermelha/Preta</option>
                  <option value="preta" ${a.faixa==="preta"?"selected":""}>Preta</option>
                </select>
              </td>
              <td>
                <button class="btn btn-success mb-10" onclick="salvarFaixa('${doc.id}')">Salvar</button>
                <button class="btn btn-secondary mb-10" onclick="verFicha('${doc.id}')">Ficha</button>
		<img src="images/lixo.png" alt="Remover aluno" title="Remover aluno"   style="width: 24px; cursor: pointer;" onclick="removerAluno('${doc.id}','${a.nome}')" />

              </td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(() => alert("Erro ao carregar alunos"));
    }

    function salvarFaixa(alunoId) {
      const faixa = document.getElementById(`faixa-${alunoId}`).value;
      if (!faixa) { alert("Selecione uma faixa"); return; }
      if (!confirm("Deseja salvar a nova faixa?")) return;

      db.collection("alunos").doc(alunoId).update({ faixa })
        .then(() => alert("Faixa atualizada com sucesso"))
        .catch(() => alert("Erro ao atualizar faixa"));
    }

    function verFicha(alunoId) {
      window.location.href = `ficha-aluno.html?id=${alunoId}`;
    }

    function removerAluno(id, nome) {
      if (!confirm(`Deseja remover o aluno ${nome}?`)) return;

      db.collection("alunos").doc(id).delete()
        .then(() => { alert("Aluno removido"); carregarAlunos(); })
        .catch(() => alert("Erro ao remover aluno"));
    }

    function logout() {
      auth.signOut().then(() => window.location.href = "index.html");
    }
  </script>

	</body>
</html>
