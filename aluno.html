<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Área do Aluno</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<h2>Dados do Aluno</h2>

<label>Nome</label><br>
<input id="nome"><br><br>

<label>Data de Nascimento</label><br>
<input id="dataNascimento" type="date"><br><br>

<label>Sexo</label><br>
<select id="sexo">
  <option>Masculino</option>
  <option>Feminino</option>
</select><br><br>

<label>Endereço</label><br>
<input id="endereco"><br><br>

<label>Telefone</label><br>
<input id="telefone"><br><br>

<label>Faixa</label><br>
<input id="faixa" disabled><br><br>

<label>Email</label><br>
<input id="email" disabled><br><br>

<h2>Meus Documentos</h2>

<label>RG:</label>
<input type="file" id="docRG"><button onclick="uploadDocumento('rg')">Enviar</button><br>

<label>Foto:</label>
<input type="file" id="docFoto"><button onclick="uploadDocumento('foto')">Enviar</button><br>

<label>Atestado:</label>
<input type="file" id="docAtestado"><button onclick="uploadDocumento('atestado')">Enviar</button><br>

<ul id="listaDocumentos"></ul>


<button onclick="salvar()">Salvar alterações</button>
<button onclick="logout()">Sair</button>


<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDTcmFtCpgb-krAJ6OniJSXIXnkoxGzWF4",
    authDomain: "sistema-taekwondo-1.firebaseapp.com",
    projectId: "sistema-taekwondo-1",
    storageBucket: "sistema-taekwondo-1.firebasestorage.app",
    messagingSenderId: "635745416768",
    appId: "1:635745416768:web:58d23eca722878f047d1a5"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  let uid = null;

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    uid = user.uid;

    db.collection("alunos").doc(uid).get().then(doc => {
      if (!doc.exists) {
        alert("Aluno não encontrado");
        return;
      }

      const d = doc.data();

      nome.value = d.nome || "";
      dataNascimento.value = d.dataNascimento || "";
      sexo.value = d.sexo || "";
      endereco.value = d.endereco || "";
      telefone.value = d.telefone || "";
      faixa.value = d.faixa || "";
      email.value = d.email || "";
    });
  });

  function salvar() {
    db.collection("alunos").doc(uid).update({
      nome: nome.value,
      dataNascimento: dataNascimento.value,
      sexo: sexo.value,
      endereco: endereco.value,
      telefone: telefone.value
    })
    .then(() => alert("Dados atualizados com sucesso!"))
    .catch(err => alert(err.message));
  }

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "index.html";
    });
  }

const storage = firebase.storage();

function uploadDocumento(tipo) {
  const input = document.getElementById(`doc${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
  const file = input.files[0];

  if (!file) {
    alert("Selecione um arquivo!");
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    alert("Usuário não logado!");
    return;
  }

  const path = `alunos/${user.uid}/${tipo}_${file.name}`;
  const storageRef = storage.ref(path);

  storageRef.put(file)
    .then(snapshot => snapshot.ref.getDownloadURL())
    .then(url => {
      // Salva a URL no Firestore
      return db.collection("alunos").doc(user.uid).update({
        [`documentos.${tipo}`]: url
      });
    })
    .then(() => {
      alert(`${tipo.toUpperCase()} enviado com sucesso!`);
      listarDocumentos();
    })
    .catch(err => {
      console.error(err);
      alert("Erro ao enviar documento");
    });
}

// Lista documentos existentes
function listarDocumentos() {
  const user = auth.currentUser;
  if (!user) return;

  db.collection("alunos").doc(user.uid).get()
    .then(doc => {
      const docs = doc.data().documentos || {};
      const lista = document.getElementById("listaDocumentos");
      lista.innerHTML = "";

      for (const [tipo, url] of Object.entries(docs)) {
        const li = document.createElement("li");
        li.innerHTML = `<a href="${url}" target="_blank">${tipo.toUpperCase()}</a>`;
        lista.appendChild(li);
      }
    });
}

// Chama ao carregar a página
auth.onAuthStateChanged(user => {
  if (user) listarDocumentos();
});


  
</script>


</body>
</html>
