<!DOCTYPE HTML>
<html>
	<head>
		<title>Painel do Professor - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>

	<body class="is-preload">
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Header -->
			<header id="header">
				
				<div class="inner">
				<!-- Logo -->
					<a href="index.html" class="logo">
						<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>
				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					<li><a href="presenca.html">Presença</a></li>
					<li><a href="historico-aluno.html">Histórico de presença</a></li>
					<input type="button" value="Sair" class="primary" onclick="logout()" />
				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">
					<h1>Alunos cadastrados</h1>
					<table>
        					<thead>
          						<tr>
								<th>Nome</th>
								<th>Telefone</th>
								<th>Faixa</th>
								<th>Ações</th>
							</tr>
						</thead>
						<tbody id="listaAlunos"></tbody>
					</table>
				</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

			<script>
			const usuario = JSON.parse(localStorage.getItem('usuario'));
			
			if (!usuario || usuario.tipo !== 'professor') {
			  window.location.href = 'index.html';
			}
			
			const API_URL = 'https://script.google.com/macros/s/AKfycbyuT3IuGy-0uYIPlL2PE2hQVy5nMuDEC-Sc6BbfleIQke5lvhnCu9rgiFi6kDGryR_zkw/exec';
			
			fetch(API_URL, {
			  method: 'POST',
			  body: new URLSearchParams({
			    acao: 'listarAlunos'
			  })
			})
			.then(r => r.json())
			.then(res => {
			  if (res.status !== 'sucesso') {
			    alert(res.msg);
			    return;
			  }
			
			  const tbody = document.getElementById('listaAlunos');
			
			  res.dados.forEach(a => {
			    const tr = document.createElement('tr');
			
			    tr.innerHTML = `
				  <td>${a.nome}</td>
				  <td>${a.email}</td>
				  <td>
					  <select onchange="salvarFaixa('${a.idAluno}', this.value)">
					    <option value="">-</option>
					    <option value="branca" ${a.faixa === 'branca' ? 'selected' : ''}>Branca</option>
					    <option value="amarela" ${a.faixa === 'amarela' ? 'selected' : ''}>Amarela</option>
					    <option value="amarela/verde" ${a.faixa === 'amarela/verde' ? 'selected' : ''}>Amarela/Verde</option>
					    <option value="verde" ${a.faixa === 'verde' ? 'selected' : ''}>Verde</option>
					    <option value="verde/azul" ${a.faixa === 'verde/azul' ? 'selected' : ''}>Verde/Azul</option>
					    <option value="azul" ${a.faixa === 'azul' ? 'selected' : ''}>Azul</option>
					    <option value="azul/vermelha" ${a.faixa === 'azul/vermelha' ? 'selected' : ''}>Azul/Vermelha</option>
					    <option value="vermelha" ${a.faixa === 'vermelha' ? 'selected' : ''}>Vermelha</option>
					    <option value="vermelha/preta" ${a.faixa === 'vermelha/preta' ? 'selected' : ''}>Vermelha/Preta</option>
					    <option value="preta" ${a.faixa === 'preta' ? 'selected' : ''}>Preta</option>
					  </select>
					</td>
			
					<td>
						<a href="${a.pastaDrive}" target="_blank">Abrir pasta</a>
						<button class="btn btn-secondary mb-10" onclick="verFicha('${doc.id}')">Ficha</button>
						<button onclick="verArquivos('${a.pastaId}', '${a.nome}')">Arquivos</button>	
					</td>
				`;
				tbody.appendChild(tr);
			  });
				}).catch(() => { alert('Erro ao carregar alunos'); });

			function salvarFaixa(idAluno, faixa) {
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'atualizarFaixa',
			      idAluno: idAluno,
			      faixa: faixa
			    })
			  })
			  .then(r => r.json())
			  .then(res => {
			    if (res.status !== 'sucesso') {
			      alert(res.msg || 'Erro ao salvar faixa');
			    }
			  })
			  .catch(() => {
			    alert('Erro ao salvar faixa');
			  });
			}

			function logout() {
		  		localStorage.removeItem('usuario');
		  		window.location.href = 'index.html';
			}

				function verArquivos(pastaId, nomeAluno) {
  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'listarArquivosAluno',
      pastaId: pastaId
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso') {
      alert(res.msg);
      return;
    }

    let html = `Arquivos de ${nomeAluno}\n\n`;

    res.dados.forEach(a => {
      html += `• ${a.nome}\n${a.url}\n\n`;
    });

    alert(html);
  })
  .catch(() => {
    alert('Erro ao carregar arquivos');
  });
}

		</script>
	</body>
</html>
