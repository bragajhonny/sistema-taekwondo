<!DOCTYPE HTML>
<html>
	<head>
		<title>Painel do Professor - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>

	<body class="is-preload">
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Header -->
			<header id="header">
			  <div class="inner">
			    <a href="professor.html" class="logo">
			      <span class="symbol"><img src="images/logo.svg" alt="" /></span>
			      <span class="title">CT Gerivaldo Silva</span>
			    </a>
			  </div>
			
			  <nav>
			    <ul>
			      <li><a href="#menu">Menu</a></li>
			    </ul>
			  </nav>
			</header>


			  <!-- MENU -->
			  <nav id="menu">
			  	<h2>Menu</h2>
			 	 <ul id="menuLinks"></ul>
			  	<input type="button" value="Sair" class="primary" onclick="logout()" />
			</nav>


			<!-- Main -->
			<div id="main">
				<div class="inner">
					<h1>Painel do professor</h1>
					<table>
        					<thead>
          					<tr>
								<td></td>
								<th>Nome</th>
								<th>Telefone</th>
								<th>Faixa</th>
								<th>A√ß√µes</th>
							</tr>
						</thead>
						<tbody id="listaAlunos"></tbody>
					</table>
				</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

			<script>
				/* =========================
				   CONFIG
				========================= */
				const API_URL = 'https://script.google.com/macros/s/AKfycbxxffkMxV6KFe9DOMG46NSH5RcEgQ6z9R-Gc5KUq9yLP2RNOqP3iC4r3JAVdHPMuiKnIQ/exec';
				const usuario = JSON.parse(localStorage.getItem('usuario'));

				if (!usuario || usuario.tipo !== 'professor') {
				  window.location.href = 'index.html';
				}
				/* =========================
				   INIT
				========================= */
				document.addEventListener('DOMContentLoaded', () => {
				  configurarMenu();
				});
				
				/* =========================
				   MENU DIN√ÇMICO
				========================= */
				function configurarMenu() {
				  const menu = document.getElementById('menuLinks');
				  menu.innerHTML = '';
				
				  menu.innerHTML += `<li><a href="perfil.html">Meu perfil</a></li>`;
				  menu.innerHTML += `<li><a href="editar-dados.html">Editar dados</a></li>`;
					
				  if (usuario.tipo === 'aluno') {
				    menu.innerHTML += `<li><a href="historico-aluno.html">Hist√≥rico de presen√ßa</a></li>`;
				  }
				
				  if (usuario.tipo === 'professor') {
				    menu.innerHTML += `<li><a href="presenca.html">Presen√ßa</a></li>
				    <li><a href="professor.html">Painel do professor</a></li>
				    `;
				  }
				}
				
				//---------------------------
				
				
			
			fetch(API_URL, {
			  method: 'POST',
			  body: new URLSearchParams({
			    acao: 'listarAlunos'
			  })
			})
			.then(r => r.json())
			.then(res => {
			  if (res.status !== 'sucesso') {
			    alert(res.msg);
			    return;
			  }
			
			  const tbody = document.getElementById('listaAlunos');
				tbody.innerHTML = '';
			
			  res.dados.forEach(a => {
				  console.log(a);
			    const tr = document.createElement('tr');
			    const fotoUrl = a.fotoPerfil ? `https://lh3.googleusercontent.com/d/${a.fotoPerfil}` : 'images/foto-padrao.png';

				tr.innerHTML = `
  					<td> <img src="${fotoUrl}" class="foto-aluno-tabela" onerror="this.src='images/foto-padrao.png'" > </td>
				  <td>${a.nome}</td>
				  <td>${a.telefone}</td>
				  <td>
					  <select onchange="salvarFaixa('${a.idAluno}', this.value)">
					    <option value="">-</option>
					    <option value="branca" ${a.faixa === 'branca' ? 'selected' : ''}>Branca</option>
					    <option value="amarela" ${a.faixa === 'amarela' ? 'selected' : ''}>Amarela</option>
					    <option value="amarela/verde" ${a.faixa === 'amarela/verde' ? 'selected' : ''}>Amarela/Verde</option>
					    <option value="verde" ${a.faixa === 'verde' ? 'selected' : ''}>Verde</option>
					    <option value="verde/azul" ${a.faixa === 'verde/azul' ? 'selected' : ''}>Verde/Azul</option>
					    <option value="azul" ${a.faixa === 'azul' ? 'selected' : ''}>Azul</option>
					    <option value="azul/vermelha" ${a.faixa === 'azul/vermelha' ? 'selected' : ''}>Azul/Vermelha</option>
					    <option value="vermelha" ${a.faixa === 'vermelha' ? 'selected' : ''}>Vermelha</option>
					    <option value="vermelha/preta" ${a.faixa === 'vermelha/preta' ? 'selected' : ''}>Vermelha/Preta</option>
					    <option value="preta" ${a.faixa === 'preta' ? 'selected' : ''}>Preta</option>
					  </select>
					</td>
			
					<td>
						<!-- <a href="${a.pastaDrive}" target="_blank">Abrir pasta</a> -->
						<button class="small" onclick="abrirFichaAluno('${a.email}')">Ficha</button>
						<button class="small" onclick="abrirModalArquivosProfessor( '${a.pastaId}', '${a.nome}', '${a.email}')">Arquivos</button>
					</td>
				`;
				tbody.appendChild(tr);
			  });
				}).catch(() => { alert('Erro ao carregar alunos'); });

			function salvarFaixa(idAluno, faixa) {
			  fetch(API_URL, {
			    method: 'POST',
			    body: new URLSearchParams({
			      acao: 'atualizarFaixa',
			      idAluno: idAluno,
			      faixa: faixa
			    })
			  })
			  .then(r => r.json())
			  .then(res => {
			    if (res.status !== 'sucesso') {
			      alert(res.msg || 'Erro ao salvar faixa');
			    }
			  })
			  .catch(() => {
			    alert('Erro ao salvar faixa');
			  });
			}

				

			function logout() {
		  		localStorage.removeItem('usuario');
		  		window.location.href = 'index.html';
			}

function fecharModalArquivos() {
  document.getElementById('modalArquivos').style.display = 'none';
}

function abrirModalTrocarSenha() {
  document.getElementById('senhaAtual').value = '';
  document.getElementById('novaSenha').value = '';
  document.getElementById('modalTrocarSenha').style.display = 'block';
}

function fecharModalTrocarSenha() {
  document.getElementById('modalTrocarSenha').style.display = 'none';
}

function trocarSenha() {
  const usuario = JSON.parse(localStorage.getItem('usuario'));

  const senhaAtual = document.getElementById('senhaAtual').value.trim();
  const novaSenha = document.getElementById('novaSenha').value.trim();

  if (!senhaAtual || !novaSenha) {
    alert('Preencha todos os campos');
    return;
  }

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'trocarSenha',
      email: usuario.email,
      senhaAtual: senhaAtual,
      novaSenha: novaSenha
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'sucesso') {
      alert(res.msg);
      fecharModalTrocarSenha();
    } else {
      alert(res.msg);
    }
  })
  .catch(() => {
    alert('Erro ao trocar senha');
  });
}

let pastaAtualId = '';
let emailAlunoAtual = '';

function abrirModalArquivosProfessor(pastaId, nomeAluno, emailAluno) {
  pastaAtualId = pastaId;
  emailAlunoAtual = emailAluno;

  document.getElementById('tituloModalArquivos').innerText = `Arquivos de \n ${nomeAluno}`;

  document.getElementById('modalArquivos').style.display = 'block';
  listarArquivos();
}

function listarArquivos() {
  document.getElementById('conteudoArquivos').innerHTML = 'Carregando...';

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'listarArquivosAluno',
      pastaId: pastaAtualId
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso') {
      document.getElementById('conteudoArquivos').innerText = 'Erro ao carregar arquivos';
      return;
    }

    if (!Array.isArray(res.dados) || res.dados.length === 0) {
      document.getElementById('conteudoArquivos').innerText = 'Nenhum arquivo encontrado.';
      return;
    }

    let html = '<ul>';

    res.dados.forEach(a => {
      const downloadUrl = `https://drive.google.com/uc?export=download&id=${a.id}`;

      html += `
        <li>
          üìÑ ${a.nome}<br>
          <a href="${a.url}" target="_blank">Abrir</a> |
          <a href="${downloadUrl}" target="_blank">Download</a> |
          <a href="#" onclick="excluirArquivo('${a.id}')">Excluir</a>
        </li><br>
      `;
    });

    html += '</ul>';

    document.getElementById('conteudoArquivos').innerHTML = html;
  })
  .catch(() => {
    document.getElementById('conteudoArquivos').innerText = 'Erro ao carregar arquivos';
  });
}

function enviarArquivo() {
  const input = document.getElementById('arquivoUpload');
  const file = input.files[0];

  if (!file) {
    alert('Selecione um arquivo');
    return;
  }

  const reader = new FileReader();

  reader.onload = function () {
    const base64 = reader.result.split(',')[1];

    fetch(API_URL, {
      method: 'POST',
      body: new URLSearchParams({
        acao: 'uploadArquivoAluno',
        email: emailAlunoAtual,
        nomeArquivo: file.name,
        tipoArquivo: file.type,
        conteudo: base64
      })
    })
    .then(r => r.json())
    .then(res => {
      if (res.status === 'sucesso') {
        input.value = '';
        listarArquivos();
      } else {
        alert(res.msg);
      }
    })
    .catch(() => alert('Erro ao enviar arquivo'));
  };

  reader.readAsDataURL(file);
}

function excluirArquivo(arquivoId) {
  if (!confirm('Deseja excluir este arquivo?')) return;

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'excluirArquivoAluno',
      arquivoId: arquivoId
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'sucesso') {
      listarArquivos();
    } else {
      alert(res.msg);
    }
  });
}

function abrirFichaAluno(emailAluno) {
  document.getElementById('modalFichaAluno').style.display = 'block';

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams({
      acao: 'buscarAluno',
      email: emailAluno
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status !== 'sucesso') {
      alert(res.msg);
      return;
    }

    const a = res.dados;

    document.getElementById('f_nome').innerText = a.nome;
    document.getElementById('f_dataNascimento').innerText = formatarDataBR(a.dataNascimento);
    document.getElementById('f_sexo').innerText = a.sexo;
    document.getElementById('f_telefone').innerText = a.telefone;
    document.getElementById('f_endereco').innerText = a.endereco;
    document.getElementById('f_tipoSanguineo').innerText = a.tipoSanguineo;
    document.getElementById('f_rg').innerText = a.rg;
    document.getElementById('f_cpf').innerText = a.cpf;
    document.getElementById('f_email').innerText = a.email;
    document.getElementById('f_faixa').innerText = a.faixa || 'N√£o definida';
  })
  .catch(() => {
    alert('Erro ao carregar ficha do aluno');
  });
}

function fecharFichaAluno() {
  document.getElementById('modalFichaAluno').style.display = 'none';
}

function formatarDataBR(dataISO) {
  if (!dataISO) return '';

  const data = new Date(dataISO);

  return data.toLocaleDateString('pt-BR', {
    timeZone: 'America/Sao_Paulo'
  });
}

				
		</script>

	<!-- Modal Arquivos -->
	<div id="modalArquivos" class="modal">
		<div class="modal-content">
			<span class="close" onclick="fecharModalArquivos()">&times;</span>

			<h2 id="tituloModalArquivos">Arquivos</h2>

			<!-- Upload -->
			<div class="field">
				<input type="file" id="arquivoUpload">
				<button class="button small" onclick="enviarArquivo()">Enviar arquivo</button>
    		</div>
    		<hr>
    		<div id="conteudoArquivos">Carregando arquivos...</div>
    		<br>
    		<button class="button small" onclick="fecharModalArquivos()">Fechar</button>
		</div>
	</div>


			<!-- Modal Trocar Senha -->
<div id="modalTrocarSenha" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModalTrocarSenha()">&times;</span>

    <h2>Trocar senha</h2>

    <div class="field">
      <label>Senha atual</label>
      <input type="password" id="senhaAtual" />
    </div>

    <div class="field">
      <label>Nova senha</label>
      <input type="password" id="novaSenha" />
    </div>

    <br>
    <button class="button primary" onclick="trocarSenha()">Salvar</button>
    <button class="button" onclick="fecharModalTrocarSenha()">Cancelar</button>
  </div>
</div>

			<!-- Modal Ficha do Aluno -->
<div id="modalFichaAluno" class="modal">
  <div class="modal-content ficha-aluno">
    <span class="close" onclick="fecharFichaAluno()">&times;</span>

    <h2>Ficha do Aluno</h2>

    <table>
      <tbody>
        <tr><td>Nome</td><td id="f_nome"></td></tr>
        <tr><td>Data de nascimento</td><td id="f_dataNascimento"></td></tr>
        <tr><td>Sexo</td><td id="f_sexo"></td></tr>
		  <tr><td>Endere√ßo</td><td id="f_endereco"></td></tr>
		  <tr><td>E-mail</td><td id="f_email"></td></tr>
        <tr><td>Telefone</td><td id="f_telefone"></td></tr>
        <tr><td>Tipo sangu√≠neo</td><td id="f_tipoSanguineo"></td></tr>
        <tr><td>RG</td><td id="f_rg"></td></tr>
        <tr><td>CPF</td><td id="f_cpf"></td></tr>
        
        <tr><td>Faixa</td><td id="f_faixa"></td></tr>
      </tbody>
    </table>

    <br>
    <button class="button small" onclick="fecharFichaAluno()">Fechar</button>

  </div>
</div>


	</body>
</html>
