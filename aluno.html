<!DOCTYPE HTML>
<html>
	<head>
		<title>Painel do Aluno - CT Gerivaldo Silva</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

		<script>
			const usuario = JSON.parse(localStorage.getItem('usuario'));

			if (!usuario || usuario.tipo !== 'aluno') {
  				window.location.href = 'index.html';
			}
		</script>

	</head>

	<body class="is-preload">
	<!-- Wrapper -->
	<div id="wrapper">
		<!-- Header -->
		<header id="header">
			<div class="inner">
				<!-- Logo -->
				<a href="index.html" class="logo">
					<span class="symbol"><img src="images/logo.svg" alt="" /></span><span class="title">CT Gerivaldo Silva</span>
				</a>
			</div>

			<!-- Nav -->
			<nav>
				<ul>
					<li><a href="#menu">Menu</a></li>
				</ul>
			</nav>
		</header>

		<!-- Menu -->
		<nav id="menu">
			<h2>Menu</h2>
			<ul>
				<li><a href="historico-aluno.html">Histórico de presença</a></li>
				<input type="button" value="Sair" class="primary" onclick="logout()" />
			</ul>
		</nav>

		<!-- Main -->
		<div id="main">
			<div class="inner">
				<h1>Painel do Aluno</h1>
						
				<table>
					<tbody>
						<tr>
							<td>Nome</td>
							<td><input type="text" id="nome" placeholder="Nome"></td>
						</tr>
						<tr>
							<td>Data de nascimento</td>
							<td><input type="text" id="dataNascimento"></td>
						</tr>
						<tr>
							<td>Sexo</td>
							<td><input type="text" id="sexo"></td>
						</tr>
						<tr>
							<td>Telefone</td>
							<td><input type="text" id="telefone"></td>
						</tr>
						<tr>
							<td>Endereço</td>
							<td><input type="text" id="endereco" placeholder="Endereço"></td>
						</tr>
						<tr>
							<td>Tipo Sanguineo</td>
							<td><input type="text" id="tipoSanguineo"></td>
						</tr>
						<tr>
							<td>RG</td>
							<td><input type="text" id="rg" placeholder="RG" ></td>
						</tr>
						<tr>
							<td>CPF</td>
							<td><input type="text" id="cpf" placeholder="CPF" ></td>
						</tr>
						<tr>
							<td>E-mail</td>
							<td><input type="text" id="email" disabled></td>
						</tr>
						<tr>
							<td>Faixa</td>
							<td><input type="text" id="faixa" disabled></td>
						</tr>
						<tr>
							<td><input type="file" id="arquivoAluno"></td>
							<td><input type="button" value="Enviar arquivo" class="primary" onclick="enviarArquivo()"></td>
						</tr>
					</tbody>
				</table>
				<ul class="actions">
					<li><input type="button" value="Salvar alterações" class="primary" onclick="salvarDados()" /></li>
					<li><input type="button" value="Minha pasta" onclick="window.open(window.pastaDriveAluno, '_blank')" /></li>
				</ul>
			</div>
		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyU6GO3aaUgGkyHoqOPXuqpejavlDW2BCt_G3DOxK90Buqmr-C2GYy7iEjYBm-DCKA7yg/exec';

fetch(API_URL, {
  method: 'POST',
  body: new URLSearchParams({
    acao: 'buscarAluno',
    email: usuario.email
  })
})
.then(r => r.json())
.then(res => {
  if (res.status !== 'sucesso') {
    alert(res.msg);
    return;
  }

  const a = res.dados;

  document.getElementById('nome').value = a.nome;
  document.getElementById('dataNascimento').value = a.dataNascimento;
  document.getElementById('sexo').value = a.sexo;
  document.getElementById('telefone').value = a.telefone;
  document.getElementById('endereco').value = a.endereco;
  document.getElementById('tipoSanguineo').value = a.tipoSanguineo;
  document.getElementById('rg').value = a.rg;
  document.getElementById('cpf').value = a.cpf;
  document.getElementById('email').value = a.email;
  document.getElementById('faixa').value = a.faixa || 'Não definida';

  // guarda link da pasta para uso futuro
  window.pastaDriveAluno = a.pastaDrive;
})
.catch(() => {
  alert('Erro ao carregar dados do aluno');
});

// LOGOUT
function logout() {
  localStorage.removeItem('usuario');
  window.location.href = 'index.html';
}

// SALVAR ALTERAÇÕES (vamos implementar já já)
function salvarDados() {
  const dados = {
    acao: 'atualizarAluno',
    email: usuario.email,
    nome: document.getElementById('nome').value,
    dataNascimento: document.getElementById('dataNascimento').value,
    sexo: document.getElementById('sexo').value,
    telefone: document.getElementById('telefone').value,
    endereco: document.getElementById('endereco').value,
    tipoSanguineo: document.getElementById('tipoSanguineo').value,
    rg: document.getElementById('rg').value,
    cpf: document.getElementById('cpf').value
  };

  fetch(API_URL, {
    method: 'POST',
    body: new URLSearchParams(dados)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'sucesso') {
      alert('Dados salvos com sucesso');
    } else {
      alert(res.msg);
    }
  })
  .catch(() => {
    alert('Erro ao salvar dados');
  });
}

	function logout() {
  localStorage.removeItem('usuario');
  window.location.href = 'index.html';
}

	function enviarArquivo() {
  const input = document.getElementById('arquivoAluno');
  const file = input.files[0];

  if (!file) {
    alert('Selecione um arquivo');
    return;
  }

  const reader = new FileReader();

  reader.onload = function () {
    const base64 = reader.result.split(',')[1];

    fetch(API_URL, {
      method: 'POST',
      body: new URLSearchParams({
        acao: 'uploadArquivoAluno',
        email: usuario.email,
        nomeArquivo: file.name,
        tipoArquivo: file.type,
        conteudo: base64
      })
    })
    .then(r => r.json())
    .then(res => {
      if (res.status === 'sucesso') {
        alert('Arquivo enviado com sucesso');
        input.value = '';
      } else {
        alert(res.msg);
      }
    })
    .catch(() => alert('Erro ao enviar arquivo'));
  };

  reader.readAsDataURL(file);
}
	
</script>



		
<!--
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDTcmFtCpgb-krAJ6OniJSXIXnkoxGzWF4",
      authDomain: "sistema-taekwondo-1.firebaseapp.com",
      projectId: "sistema-taekwondo-1",
      messagingSenderId: "635745416768",
      appId: "1:635745416768:web:58d23eca722878f047d1a5"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();
    let alunoUID = null;

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      alunoUID = user.uid;

      db.collection("alunos").doc(alunoUID).get()
        .then(doc => {
          if (!doc.exists || doc.data().perfil !== "aluno") {
            alert("Acesso negado");
            window.location.href = "index.html";
            return;
          }

          preencherFormulario(doc.data());
        });
    });

    function preencherFormulario(data) {
  nome.value = data.nome || "";
  dataNascimento.value = data.dataNascimento || "";
  sexo.value = data.sexo || "";
  endereco.value = data.endereco || "";
  telefone.value = data.telefone || "";
  tipoSanguineo.value = data.tipoSanguineo || "";
  faixa.value = data.faixa || "";
  email.value = data.email || "";
  rg.value = data.rg || "";
  cpf.value = data.cpf || "";
}


    function salvarDados() {
  db.collection("alunos").doc(alunoUID).update({
    nome: nome.value,
    dataNascimento: dataNascimento.value,
    sexo: sexo.value,
    endereco: endereco.value,
    telefone: telefone.value,
    tipoSanguineo: tipoSanguineo.value,
    rg: rg.value,
    cpf: cpf.value
  })
  .then(() => alert("Dados atualizados com sucesso"))
  .catch((erro) => {
    console.error(erro);
    alert("Erro ao salvar dados");
  });
}


    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
		-->
	</body>
</html>
